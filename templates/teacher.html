<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocaFlow - Teacher Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fefefe;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 28px;
        }
        
        .header {
            background: #ffffff;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ea580c 0%, #0ea5e9 100%);
        }
        
        .header h1 {
            color: #0f172a;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.03em;
        }
        
        .header p {
            color: #6b7280;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            border: none;
        }
        
        .nav-tab {
            padding: 10px 18px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #ea580c;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .nav-tab:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #1f2937;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .nav-tab:hover::before {
            transform: scaleX(1);
        }
        
        .nav-tab.active {
            background: #ea580c;
            color: #ffffff;
            border-color: #ea580c;
            box-shadow: 0 2px 8px rgba(234, 88, 12, 0.3);
            transform: translateY(0);
        }
        
        .nav-tab.active::before {
            transform: scaleX(0);
        }
        
        .tab-content {
            display: none;
            background: #ffffff;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            min-height: 400px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .assignment-form {
            display: grid;
            gap: 24px;
            background: #ffffff;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            letter-spacing: 0;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 11px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s ease;
            font-family: inherit;
            background: #ffffff;
            color: #1f2937;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
            transform: translateY(0);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .form-section {
            padding: 24px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.01em;
        }
        
        .form-section-title::before {
            content: '';
            width: 3px;
            height: 18px;
            background: #ea580c;
            border-radius: 2px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: #ea580c;
            color: #ffffff;
            border: 1px solid #ea580c;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            background: #dc2626;
            border-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(234, 88, 12, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(234, 88, 12, 0.2);
        }
        
        .btn-secondary {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .assignments-list {
            display: grid;
            gap: 24px;
        }
        
        .assignment-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 28px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            opacity: 0;
            animation: fadeInUp 0.5s ease forwards;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .assignment-card:nth-child(1) { animation-delay: 0.05s; }
        .assignment-card:nth-child(2) { animation-delay: 0.1s; }
        .assignment-card:nth-child(3) { animation-delay: 0.15s; }
        .assignment-card:nth-child(4) { animation-delay: 0.2s; }
        .assignment-card:nth-child(5) { animation-delay: 0.25s; }
        .assignment-card:nth-child(6) { animation-delay: 0.3s; }
        
        .assignment-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ea580c;
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 8px 0 0 8px;
        }
        
        .assignment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: #ea580c;
        }
        
        .assignment-card:hover::before {
            transform: scaleY(1);
        }
        
        .assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 1 !important;
            display: block !important;
            width: 18px !important;
            height: 18px !important;
            cursor: pointer !important;
        }
        
        .assignment-card:hover .assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Force checkbox visibility - ALWAYS VISIBLE */
        input[type="checkbox"].assignment-checkbox {
            -webkit-appearance: checkbox !important;
            -moz-appearance: checkbox !important;
            appearance: checkbox !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 999 !important;
            display: inline-block !important;
            width: 18px !important;
            height: 18px !important;
            cursor: pointer !important;
            background: white !important;
            border: 2px solid #d1d5db !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Make sure checkboxes are visible in ALL states */
        input[type="checkbox"].assignment-checkbox:before,
        input[type="checkbox"].assignment-checkbox:after,
        input[type="checkbox"].assignment-checkbox:hover,
        input[type="checkbox"].assignment-checkbox:focus,
        input[type="checkbox"].assignment-checkbox:active {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Override any parent hover effects */
        * input[type="checkbox"].assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        
        /* Force visibility on any parent element hover */
        .assignment-card * input[type="checkbox"].assignment-checkbox,
        .assignment-header * input[type="checkbox"].assignment-checkbox,
        .assignment-card:hover * input[type="checkbox"].assignment-checkbox,
        .assignment-header:hover * input[type="checkbox"].assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        
        input[type="checkbox"].assignment-checkbox:checked {
            background-color: #ea580c !important;
            border-color: #ea580c !important;
        }
        
        input[type="checkbox"].assignment-checkbox:hover {
            border-color: #ea580c !important;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2) !important;
        }
        
        input[type="checkbox"].assignment-checkbox:focus {
            outline: 2px solid #ea580c !important;
            outline-offset: 2px !important;
        }
        
        .assignment-card h3 {
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .assignment-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .assignment-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
            flex: 1;
        }
        
        .assignment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 7px 14px;
            font-size: 13px;
            border-radius: 5px;
        }
        
        .btn-xs {
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 28px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #ea580c;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: #ea580c;
        }
        
        .stat-card:hover::after {
            transform: scaleX(1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .logs-table {
            width: 100%;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .logs-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .logs-table th {
            background: #f8fafc;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .logs-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
            font-size: 14px;
            color: #1f2937;
        }
        
        .logs-table tr:hover {
            background: #f8fafc;
        }
        
        .level-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: auto;
            flex-shrink: 0;
            min-width: 80px;
            text-align: center;
        }
        
        /* ACTFL Level Badges */
        .level-novice_low {
            background: #f59e0b;
            color: white;
        }
        
        .level-novice_mid {
            background: #facc15;
            color: white;
        }
        
        .level-novice_high {
            background: #84cc16;
            color: white;
        }
        
        .level-intermediate_low {
            background: #22c55e;
            color: white;
        }
        
        .level-intermediate_mid {
            background: #10b981;
            color: white;
        }
        
        .level-intermediate_high {
            background: #06b6d4;
            color: white;
        }
        
        .level-advanced {
            background: #3b82f6;
            color: white;
        }
        
        /* CEFR Level Badges */
        .level-a1 {
            background: #f59e0b;
            color: white;
        }
        
        .level-a2 {
            background: #facc15;
            color: white;
        }
        
        .level-b1 {
            background: #84cc16;
            color: white;
        }
        
        .level-b2 {
            background: #22c55e;
            color: white;
        }
        
        .level-c1 {
            background: #06b6d4;
            color: white;
        }
        
        .level-c2 {
            background: #3b82f6;
            color: white;
        }
        
        /* Legacy Level Badges */
        .level-beginner {
            background: #f59e0b;
            color: white;
        }
        
        .level-intermediate {
            background: #22c55e;
            color: white;
        }
        
        .level-advanced {
            background: #3b82f6;
            color: white;
        }
        
        .voice-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .voice-used {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .voice-not-used {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .transcript-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .transcript-used {
            background: #d4edda;
            color: #155724;
        }
        
        .transcript-not-used {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background: #f3e5f5;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-content {
            line-height: 1.5;
            margin-bottom: 5px;
        }
        
        .message-time {
            font-size: 11px;
            color: #666;
        }
        
        .message.user .message-time {
            text-align: right;
        }
        
        .message.assistant .message-time {
            text-align: left;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-header h2 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .modal-header p {
            color: #666;
            font-size: 14px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .share-link {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
            margin-bottom: 10px;
        }
        
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .copy-btn:hover {
            background: #5a6fd8;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .assignment-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .assignment-actions {
                justify-content: stretch;
            }
            
            .btn-small {
                flex: 1;
            }
        }
        
        .home-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .home-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: inherit;
        }
        
        .home-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .home-btn-absolute {
            position: absolute;
            top: 24px;
            left: 24px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .home-btn-absolute:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .menu-toggle-btn {
            position: absolute;
            top: 24px;
            left: 28px;
            width: 44px;
            height: 44px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .menu-toggle-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .menu-toggle-btn span {
            width: 20px;
            height: 2px;
            background: #374151;
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-toggle-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle-btn.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: #ffffff;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
.sidebar-menu {
    position: fixed;
    top: 0;
    left: -400px;
    width: 400px;
    height: 100vh;
    background: #ffffff;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
}
        
.sidebar-menu.active {
    left: 0;
}
        
.sidebar-header {
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    align-items: center;
        }
        
        .sidebar-header h3 {
            color: #0f172a;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-header {
            padding: 24px 48px 24px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        .menu-section {
            margin-bottom: 32px;
        }
        
        .menu-section h4 {
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }
        
        .menu-item:hover {
            background: #f8fafc;
            color: #0f172a;
        }
        
        .menu-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .account-status {
            background: linear-gradient(135deg, #fef3f2 0%, #fef9f3 100%);
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .account-status h4 {
            color: #ea580c;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .account-status p {
            color: #6b7280;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
        }
        
        .logout-btn {
            width: 100%;
            padding: 12px 16px;
            background: #dc2626;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .logout-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .classrooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 28px;
        }
        
        .classroom-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-align: left;
            overflow: hidden;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }
        
        .classroom-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .classroom-card:hover::before {
            opacity: 1;
        }
        
        .classroom-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            border-color: #cbd5e1;
        }
        
        .classroom-card .classroom-checkbox {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 10 !important;
            background: white !important;
            border: 2px solid #667eea !important;
            border-radius: 4px !important;
            transition: all 0.2s ease;
        }
        
        .classroom-card:hover .classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            border-color: #667eea !important;
        }
        
        /* Force classroom checkbox visibility */
        input[type="checkbox"].classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            position: absolute !important;
            z-index: 999 !important;
            display: block !important;
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            background: white !important;
            border: 2px solid #667eea !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Override any hover effects that might hide classroom checkboxes */
        .classroom-card:hover input[type="checkbox"].classroom-checkbox,
        .classroom-header:hover input[type="checkbox"].classroom-checkbox,
        * input[type="checkbox"].classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        input[type="checkbox"].classroom-checkbox:checked {
            background-color: #667eea !important;
            border-color: #667eea !important;
        }
        
        input[type="checkbox"].classroom-checkbox:hover {
            border-color: #764ba2 !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3) !important;
        }
        
        .classroom-header {
            margin-bottom: 20px;
            padding-left: 40px;
        }
        
        .classroom-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
            line-height: 1.2;
        }
        
        .classroom-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 0;
        }
        
        .classroom-meta span {
            padding: 6px 12px;
            background: #f8fafc;
            border-radius: 6px;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .join-code {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        .classroom-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .classroom-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .classroom-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .classroom-actions .btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .join-code {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 32px 32px 32px;
            max-width: 700px;
            width: 90%;
            max-height: 98vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            border: 1px solid #e5e7eb;
        }
        
        /* Fix spacing for classroom creation modal */
        .modal-form {
            display: grid;
            gap: 24px;
        }
        
        .modal-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 0;
        }
        
        .modal-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .modal-form .modal-actions {
            margin-top: 30px;
        }
        
        /* Classroom Modal Specific Styles */
        .classroom-modal {
            max-width: 700px;
            width: 90%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
        }
        
        .classroom-modal .modal-header {
            background: #ea580c;
            color: white;
            padding: 28px 32px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-icon {
            font-size: 32px;
            background: rgba(255, 255, 255, 0.15);
            width: 56px;
            height: 56px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .modal-title-section h2 {
            margin: 0 0 6px 0;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .modal-title-section p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
            line-height: 1.4;
            font-weight: 400;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
            pointer-events: auto;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        #conversationModal .modal-header {
            display: flex;
            justify-content: space-between;
        }
        
        #conversationModal .modal-body {
            padding: 24px;
        }
        
        .modal-close {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            font-size: 18px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            position: absolute;
            top: 16px;
            right: 16px;
        }
        
        .modal-close:hover {
            background: #e5e7eb;
            color: #1f2937;
            transform: translateY(-1px);
        }
        
        .classroom-modal .modal-form {
            padding: 0;
        }
        
        .form-section {
            padding: 32px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 24px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: inline-block;
        }
        
        .classroom-modal .form-group {
            margin-bottom: 28px;
        }
        
        .classroom-modal .form-group:last-child {
            margin-bottom: 0;
        }
        
        .classroom-modal .form-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            display: block;
            font-size: 15px;
        }
        
        .classroom-modal .form-group input,
        .classroom-modal .form-group textarea {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .classroom-modal .form-group input:focus,
        .classroom-modal .form-group textarea:focus {
            outline: none;
            border-color: #ea580c;
            background: white;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }
        
        .classroom-modal .form-group small {
            display: block;
            margin-top: 8px;
            color: #718096;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        /* Toggle Switch Styles */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .toggle-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #667eea;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        .toggle-switch:hover {
            background: #cbd5e1;
        }
        
        .toggle-switch.active:hover {
            background: #5a67d8;
        }
        
        .toggle-description {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }
        
        .classroom-modal .modal-actions {
            padding: 30px;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            border-top: 1px solid #e2e8f0;
            margin-top: 0;
        }
        
        .classroom-modal .btn {
            padding: 11px 20px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .classroom-modal .btn-secondary {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .classroom-modal .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        
        .classroom-modal .btn-primary {
            background: #ea580c;
            color: white;
            border: 1px solid #ea580c;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .classroom-modal .btn-primary:hover {
            background: #dc2626;
            border-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(234, 88, 12, 0.2);
        }
        
        .btn-icon {
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .classroom-modal {
                max-width: 95%;
                margin: 20px;
            }
            
            .classroom-modal .modal-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .modal-icon {
                width: 60px;
                height: 60px;
                font-size: 32px;
            }
            
            .modal-close-btn {
                position: static;
                margin-top: 10px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .classroom-modal .modal-actions {
                padding: 20px;
                flex-direction: column;
            }
            
            .classroom-modal .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Custom Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            color: white;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            color: white;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            color: white;
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .notification.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            color: white;
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
            opacity: 0.95;
        }
        
        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s ease;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .notification-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 400px;
            transform: translateX(500px);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .notification-modal.show {
            transform: translateX(0);
        }
        
        .notification-modal.success {
            border-left-color: #10b981;
        }
        
        .notification-modal.error {
            border-left-color: #ef4444;
        }
        
        .notification-modal.warning {
            border-left-color: #f59e0b;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .notification-message {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: #f3f4f6;
            color: #666;
        }

        /* Assignment Wizard Styles */
        .assignment-wizard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .wizard-progress {
            margin-bottom: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            text-align: center;
        }

        .step.active .step-title {
            color: #667eea;
            font-weight: 600;
        }

        .step.completed .step-title {
            color: #10b981;
        }

        .wizard-content {
            min-height: 400px;
            margin-bottom: 30px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-header h2 {
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-header p {
            color: #6b7280;
            font-size: 16px;
        }

        .characteristics-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
            align-items: stretch;
        }

        .characteristic-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            flex: 1 1 0;
            min-width: 0;
            justify-content: center;
            text-align: center;
        }

        .characteristic-item:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .characteristic-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .characteristic-item input[type="checkbox"]:checked + span {
            color: #667eea;
            font-weight: 500;
        }

        .characteristic-item:has(input:checked) {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .voice-speed-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .speed-label {
            font-weight: 500;
        }

        .speed-value {
            font-weight: 600;
            color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .review-section {
            background: #f9fafb;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .review-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 16px;
            align-items: start;
        }

        .review-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .review-value {
            color: #6b7280;
            font-size: 14px;
            word-break: break-word;
        }

        .review-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .wizard-navigation .btn {
            min-width: 120px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .welcome-section {
            background: linear-gradient(135deg, #fef3f2 0%, #fef9f3 100%);
            border-radius: 12px;
            padding: 24px 32px;
            margin-bottom: 32px;
            border: 1px solid #fed7aa;
            position: relative;
            overflow: hidden;
        }
        
        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ea580c 0%, #f97316 100%);
        }
        
        .welcome-section h2 {
            color: #0f172a;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .welcome-section p {
            color: #475569;
            font-size: 15px;
            line-height: 1.6;
            margin: 0;
        }

        /* Improved Date Picker Styles */
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .date-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            background: white;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            background: white;
            min-width: 120px;
        }

        .time-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-input:placeholder-shown {
            color: #9ca3af;
            font-style: italic;
        }

        .date-clear-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .date-clear-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .date-clear-btn:active {
            transform: scale(0.95);
        }

        /* Date input styling for WebKit browsers */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        input[type="date"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            display: none;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }

        /* Time input styling */
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        input[type="time"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            display: none;
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }

        /* Custom Date Picker Styles */
        .date-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .date-picker-input, .time-picker-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .date-display, .time-display {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            background: white;
            cursor: pointer;
            color: #374151;
        }

        .date-display:hover, .time-display:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .date-display:focus, .time-display:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-picker-icon, .time-picker-icon {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .date-clear-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .date-clear-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .date-clear-btn:active {
            transform: scale(0.95);
        }

        /* Date Picker Container */
        .date-picker-container {
            position: relative;
        }

        .date-picker-input-wrapper {
            position: relative;
        }

        .date-picker-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-picker-input-wrapper {
            position: relative;
        }

        .time-picker-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Date Picker Modal */
        .date-picker {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: auto;
            width: 320px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .date-nav-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .date-nav-btn:hover {
            background: #e5e7eb;
        }

        .currentMonth {
            font-weight: 600;
            color: #1f2937;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            padding: 16px;
        }

        .date-picker-grid .day-header {
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            font-size: 12px;
            padding: 8px 0;
        }

        .date-picker-grid .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
        }

        .date-picker-grid .day:hover {
            background: #f9fafb;
        }

        .date-picker-grid .day.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .date-picker-grid .day.other-month {
            color: #d1d5db;
        }

        .date-picker-grid .day.today {
            background: #fef3c7;
            color: #065f46;
            font-weight: 600;
        }

        /* Time Picker Container */
        .time-picker-container {
            position: relative;
        }

        /* Time Picker Modal */
        .time-picker {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: auto;
            width: 320px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
        }

        .time-picker-header {
            text-align: center;
            padding: 16px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-period-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .time-picker-grid {
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .time-section {
            flex: 1;
        }

        .time-section-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .time-picker-period {
            display: flex;
            gap: 8px;
        }

        .time-period-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-period-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .time-period-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-picker-hours {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .time-picker-minutes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .time-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .time-option {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 4px;
            background: white;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .time-option:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-1px);
        }

        .time-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-picker-footer {
            display: flex;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            gap: 12px;
        }

        .time-picker-footer .btn {
            flex: 1;
        }

        /* Validation Notification Styles */
        .validation-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .validation-content {
            background: white;
            border: 2px solid #ef4444;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.15);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .validation-icon {
            font-size: 20px;
            color: #ef4444;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .validation-message {
            flex: 1;
        }

        .validation-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .validation-text {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        .validation-close {
            background: transparent;
            border: none;
            font-size: 16px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .validation-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Custom Dropdown Component */
        .custom-dropdown {
            position: relative;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .dropdown-trigger:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dropdown-trigger.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .dropdown-arrow {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #667eea;
            transition: transform 0.3s ease;
        }

        .dropdown-trigger.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Integrated Toggle Switch */
        .dropdown-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .toggle-switch-small {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-switch-small input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-small {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider-small:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input:checked + .toggle-slider-small {
            background-color: #667eea;
        }

        input:checked + .toggle-slider-small:before {
            transform: translateX(16px);
        }

        .toggle-label-small {
            font-weight: 600;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
        }

        /* Toggle Switch in Custom Input Mode */
        .dropdown-toggle-custom {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-self: flex-start;
        }

        .dropdown-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown-section {
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-section:last-child {
            border-bottom: none;
        }

        /* Specific fix for classroom modal dropdown */
        .classroom-modal .dropdown-options {
            max-height: 300px;
            overflow-y: auto;
            z-index: 10001;
            bottom: calc(100% + 8px);
            top: auto;
        }

        .dropdown-section-title {
            padding: 12px 16px 8px 16px;
            font-size: 13px;
            font-weight: 700;
            color: #1a202c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-bottom: 1px solid #cbd5e1;
        }

        .dropdown-option {
            padding: 12px 16px;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: white;
        }

        .dropdown-option:hover {
            background: #f1f5f9;
            color: #667eea;
        }

        .dropdown-option.selected {
            background: #667eea;
            color: white;
        }

        /* Persona Header with Inline Toggle */
        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .persona-toggle-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .toggle-option-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Enhanced Form Group Spacing */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group small {
            display: block;
            margin-top: 12px;
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-label {
            font-weight: 600;
            color: #374151;
            font-size: 15px;
            cursor: pointer;
        }

        /* Dropdown Container */
        .persona-dropdown-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .persona-dropdown-container.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            max-height: 0;
            overflow: hidden;
        }

        /* Custom Avatar Container */
        .custom-avatar-container {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-avatar-input-wrapper {
            width: 100%;
        }

        .custom-avatar-input-large {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            background: white;
            color: #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }

        .custom-avatar-input-large:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .custom-avatar-input-large:focus {
            outline: none;
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .custom-avatar-hint {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
            line-height: 1.4;
            margin-top: 8px;
        }

        .dropdown-option:last-child {
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .dropdown-section:last-child .dropdown-option:last-child {
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .dropdown-section:first-child .dropdown-option:first-child {
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        .custom-persona-input {
            margin-top: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .custom-avatar-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background: white;
            color: #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .custom-avatar-field:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .custom-avatar-field:focus {
            outline: none;
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2), 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .custom-persona-input small {
            color: #6b7280;
            font-size: 12px;
            font-style: italic;
            line-height: 1.4;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 300px;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .assignment-wizard {
                padding: 20px;
            }

            .progress-steps {
                flex-wrap: wrap;
                gap: 20px;
            }

            .step {
                flex: 0 0 auto;
                min-width: 60px;
            }

            .step-title {
                font-size: 12px;
            }

            .review-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .review-actions {
                flex-direction: column;
            }

            .wizard-navigation {
                flex-direction: column;
            }

            .wizard-navigation .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: center; flex: 1;">
                    <h1>VocaFlow</h1>
                    <p>Create assignments, track student progress, and monitor engagement</p>
                </div>
            </div>
        </div>
        
        <div class="welcome-section">
            <h2>Welcome Back, <span id="teacherName">Teacher</span>!</h2>
            <p>Here's your teaching dashboard. Create assignments, monitor student progress, and manage your classrooms.</p>
        </div>
        
        <button class="menu-toggle-btn" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="classrooms" onclick="switchTab('classrooms')">Classroom Management</button>
            <button class="nav-tab" data-tab="create" onclick="switchTab('create')">Create Assignment</button>
            <button class="nav-tab" data-tab="assignments" onclick="switchTab('assignments')">My Assignments</button>
            <button class="nav-tab" data-tab="analytics" onclick="switchTab('analytics')">Analytics</button>
        </div>
        
        <!-- Classroom Management Tab -->
        <div id="classrooms-tab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">My Classrooms</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="classroomsToggleBtn" onclick="toggleClassroomsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" id="deleteSelectedClassroomsBtn" onclick="deleteSelectedClassrooms()" style="background: #dc3545; color: white;">Delete Selected</button>
                    <button class="btn btn-primary" onclick="showCreateClassroomModal()">Create New Classroom</button>
                </div>
            </div>
            <div class="classrooms-grid" id="classroomsGrid">
                <!-- Classrooms will be loaded here -->
            </div>
        </div>
        
        <!-- Teacher Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div style="max-width: 600px; margin: 0 auto;">
                <h3 style="margin-bottom: 30px; color: #333;">Teacher Profile</h3>
                
                <form class="assignment-form" onsubmit="updateTeacherProfile(event)">
                    <div class="form-group">
                        <label for="teacherName">Full Name</label>
                        <input type="text" id="teacherName" name="name" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherEmail">Email Address</label>
                        <input type="email" id="teacherEmail" name="email" required placeholder="your.email@school.edu">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherSchool">School Name</label>
                        <input type="text" id="teacherSchool" name="school" placeholder="Enter your school name">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherTitle">Title/Position</label>
                        <input type="text" id="teacherTitle" name="title" placeholder="e.g., Spanish Teacher, Department Head">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherBio">Bio (Optional)</label>
                        <textarea id="teacherBio" name="bio" placeholder="Tell your students about yourself..." style="min-height: 100px;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>
        
        <!-- Create Assignment Tab -->
        <div id="create-tab" class="tab-content">
            <!-- Assignment Wizard -->
            <div class="assignment-wizard">
                <!-- Progress Indicator -->
                <div class="wizard-progress">
                    <div class="progress-steps">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-title">Persona</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-title">Act</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-title">Recipient</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-title">Theme</div>
                        </div>
                        <div class="step" data-step="5">
                            <div class="step-number">5</div>
                            <div class="step-title">Structure</div>
                        </div>
                        <div class="step" data-step="6">
                            <div class="step-number">6</div>
                            <div class="step-title">Review</div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Content -->
                <div class="wizard-content">
                    <form id="assignmentWizardForm" class="assignment-form" onsubmit="createAssignment(event)">
                        <!-- Step 1: Persona -->
                        <div class="wizard-step active" data-step="1">
                            <div class="step-header">
                                <h2>Step 1: Persona - Who should the AI be?</h2>
                                <p>Define the avatar role and personality traits for the conversation.</p>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <div class="persona-header">
                                        <label for="assignmentPersona">Select Avatar Role</label>
                                        <!-- Toggle Switch in Upper Right -->
                                        <div class="persona-toggle-inline">
                                            <div class="toggle-option-inline">
                                                <label class="toggle-switch-small">
                                                    <input type="checkbox" id="useCustomAvatar" onchange="togglePersonaMode()">
                                                    <span class="toggle-slider-small"></span>
                                                </label>
                                                <span class="toggle-label-small">Custom</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="persona-selector">
                                        <!-- Integrated Dropdown with Toggle -->
                                        <div id="personaDropdownContainer" class="persona-dropdown-container">
                                            <div class="custom-dropdown" id="personaDropdown">
                                                <div class="dropdown-trigger" onclick="togglePersonaDropdown()">
                                                    <span id="selectedPersona">Choose a persona...</span>
                                                    <div class="dropdown-arrow"></div>
                                                </div>
                                                <div class="dropdown-options" id="personaOptions" style="display: none;">
                                                    <div class="dropdown-section">
                                                        <div class="dropdown-section-title">Everyday Scenarios</div>
                                                        <div class="dropdown-option" data-value="friend">Friend</div>
                                                        <div class="dropdown-option" data-value="family_member">Family Member</div>
                                                        <div class="dropdown-option" data-value="classmate">Classmate</div>
                                                        <div class="dropdown-option" data-value="neighbor">Neighbor</div>
                                                    </div>
                                                    <div class="dropdown-section">
                                                        <div class="dropdown-section-title">Professional Services</div>
                                                        <div class="dropdown-option" data-value="doctor">Doctor/Medical Professional</div>
                                                        <div class="dropdown-option" data-value="waiter">Waiter/Restaurant Staff</div>
                                                        <div class="dropdown-option" data-value="travel_agent">Travel Agent</div>
                                                        <div class="dropdown-option" data-value="hotel_clerk">Hotel Clerk</div>
                                                        <div class="dropdown-option" data-value="shopkeeper">Shopkeeper/Retail Worker</div>
                                                        <div class="dropdown-option" data-value="bank_teller">Bank Teller</div>
                                                        <div class="dropdown-option" data-value="police_officer">Police Officer</div>
                                                        <div class="dropdown-option" data-value="receptionist">Receptionist</div>
                                                    </div>
                                                    <div class="dropdown-section">
                                                        <div class="dropdown-section-title">Educational Settings</div>
                                                        <div class="dropdown-option" data-value="teacher">Teacher</div>
                                                        <div class="dropdown-option" data-value="tour_guide">Tour Guide</div>
                                                        <div class="dropdown-option" data-value="librarian">Librarian</div>
                                                        <div class="dropdown-option" data-value="coach">Sports Coach</div>
                                                    </div>
                                                    <div class="dropdown-section">
                                                        <div class="dropdown-section-title">Travel & Hospitality</div>
                                                        <div class="dropdown-option" data-value="flight_attendant">Flight Attendant</div>
                                                        <div class="dropdown-option" data-value="taxi_driver">Taxi Driver</div>
                                                        <div class="dropdown-option" data-value="concierge">Concierge</div>
                                                        <div class="dropdown-option" data-value="chef">Chef</div>
                                                    </div>
                                                    <div class="dropdown-section">
                                                        <div class="dropdown-section-title">Creative & Entertainment</div>
                                                        <div class="dropdown-option" data-value="artist">Artist</div>
                                                        <div class="dropdown-option" data-value="musician">Musician</div>
                                                        <div class="dropdown-option" data-value="actor">Actor/Actress</div>
                                                        <div class="dropdown-option" data-value="photographer">Photographer</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Custom Avatar Input (hidden by default) -->
                                        <div id="customAvatarContainer" class="custom-avatar-container" style="display: none;">
                                            <div class="custom-avatar-input-wrapper">
                                                <input type="text" id="customPersona" name="custom_avatar_role" placeholder="e.g., Barista at a cozy cafe, Veterinarian assistant, Personal trainer" class="custom-avatar-input-large" data-validation-message="Please fill out this required section">
                                                <div class="custom-avatar-hint">Be specific about the role and setting for better AI responses</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hidden select for form submission -->
                                        <select id="assignmentPersona" name="avatar_role" required style="display: none;">
                                            <option value="">Choose a persona...</option>
                                            <option value="friend">Friend</option>
                                            <option value="family_member">Family Member</option>
                                            <option value="classmate">Classmate</option>
                                            <option value="neighbor">Neighbor</option>
                                            <option value="doctor">Doctor/Medical Professional</option>
                                            <option value="waiter">Waiter/Restaurant Staff</option>
                                            <option value="travel_agent">Travel Agent</option>
                                            <option value="hotel_clerk">Hotel Clerk</option>
                                            <option value="shopkeeper">Shopkeeper/Retail Worker</option>
                                            <option value="bank_teller">Bank Teller</option>
                                            <option value="police_officer">Police Officer</option>
                                            <option value="receptionist">Receptionist</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="tour_guide">Tour Guide</option>
                                            <option value="librarian">Librarian</option>
                                            <option value="coach">Sports Coach</option>
                                            <option value="flight_attendant">Flight Attendant</option>
                                            <option value="taxi_driver">Taxi Driver</option>
                                            <option value="concierge">Concierge</option>
                                            <option value="chef">Chef</option>
                                            <option value="artist">Artist</option>
                                            <option value="musician">Musician</option>
                                            <option value="actor">Actor/Actress</option>
                                            <option value="photographer">Photographer</option>
                                            <option value="custom">Custom Avatar</option>
                                        </select>
                                    </div>
                                    <small>The persona sets the AI's tone, expertise, and communication style for authentic conversations.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentPersonaTraits">Persona Characteristics</label>
                                    <div class="characteristics-grid">
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="patient">
                                            <span>Patient</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="encouraging">
                                            <span>Encouraging</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="professional">
                                            <span>Professional</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="friendly">
                                            <span>Friendly</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="formal">
                                            <span>Formal</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="casual">
                                            <span>Casual</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="helpful">
                                            <span>Helpful</span>
                                        </label>
                                        <label class="characteristic-item">
                                            <input type="checkbox" name="avatar_characteristics" value="humorous">
                                            <span>Humorous</span>
                                        </label>
                                    </div>
                                    <small>Personality traits shape how the persona interacts and responds to students.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Act -->
                        <div class="wizard-step" data-step="2">
                            <div class="step-header">
                                <h2>Step 2: Act - What should students do?</h2>
                                <p>Define the clear action objectives and instructions for students.</p>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <label for="assignmentStudentObjective">Student Action Objective</label>
                                    <textarea id="assignmentStudentObjective" name="student_objective" required placeholder="e.g., Order a meal at a restaurant, Ask for directions to the museum, Make a doctor's appointment, Buy clothes at a store, Check into a hotel..." style="min-height: 100px;"></textarea>
                                    <small>Specify the clear action or task students must accomplish. This directs the AI to create purposeful conversations.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentInstructions">Student Instructions</label>
                                    <textarea id="assignmentInstructions" name="instructions" required placeholder="e.g., You are a tourist in Madrid and want to order lunch. Use polite phrases and ask about ingredients. Try to order a drink and dessert too." style="min-height: 100px;"></textarea>
                                    <small>Clear instructions help students understand their role and what's expected of them.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Recipient -->
                        <div class="wizard-step" data-step="3">
                            <div class="step-header">
                                <h2>Step 3: Recipient - Who are the students?</h2>
                                <p>Define the proficiency level and learner context for appropriate difficulty.</p>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignmentStandard">Proficiency Standard</label>
                                        <div class="custom-dropdown">
                                            <div class="dropdown-trigger" onclick="toggleDropdown('assignmentStandardDropdown')">
                                                <span id="assignmentStandardDisplay">Select Standard</span>
                                                <div class="dropdown-arrow"></div>
                                            </div>
                                            <div class="dropdown-options" id="assignmentStandardDropdown" style="display: none;">
                                                <div class="dropdown-option" data-value="Basic">Basic</div>
                                                <div class="dropdown-option" data-value="ACTFL">ACTFL (American Council on the Teaching of Foreign Languages)</div>
                                                <div class="dropdown-option" data-value="CEFR">CEFR (Common European Framework of Reference)</div>
                                            </div>
                                        </div>
                                        <select id="assignmentStandard" name="level_standard" required style="display: none;">
                                            <option value="">Select Standard</option>
                                            <option value="Basic">Basic</option>
                                            <option value="ACTFL">ACTFL (American Council on the Teaching of Foreign Languages)</option>
                                            <option value="CEFR">CEFR (Common European Framework of Reference)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="assignmentLevel">Difficulty Level</label>
                                        <div class="custom-dropdown">
                                            <div class="dropdown-trigger" onclick="toggleDropdown('assignmentLevelDropdown')">
                                                <span id="assignmentLevelDisplay">Select Level</span>
                                                <div class="dropdown-arrow"></div>
                                            </div>
                                            <div class="dropdown-options" id="assignmentLevelDropdown" style="display: none;">
                                                <!-- Options will be populated dynamically based on proficiency standard -->
                                            </div>
                                        </div>
                                        <select id="assignmentLevel" name="level" required style="display: none;">
                                            <option value="">Select Level</option>
                                            <!-- Options will be populated dynamically based on proficiency standard -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentDescription">Learner Context</label>
                                    <textarea id="assignmentDescription" name="description" required placeholder="e.g., High school Spanish students in their second year, comfortable with present tense but practicing past tense. Need confidence building in real-world conversations." style="min-height: 100px;"></textarea>
                                    <small>Describing your learners helps tailor difficulty, engagement strategies, and support level.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Theme -->
                        <div class="wizard-step" data-step="4">
                            <div class="step-header">
                                <h2>Step 4: Theme - What's the conversation context?</h2>
                                <p>Set the conversational context, vocabulary focus, and assignment details.</p>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <label for="assignmentTitle">Assignment Title</label>
                                    <input type="text" id="assignmentTitle" name="title" required placeholder="e.g., Ordering Food at a Spanish Restaurant">
                                    <small>A clear title focuses the conversation on the specific context and vocabulary.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentTheme">Theme & Vocabulary Focus</label>
                                    <textarea id="assignmentTheme" name="theme" placeholder="e.g., Restaurant dining, food vocabulary, ordering phrases, making requests, paying the bill" style="min-height: 80px;"></textarea>
                                    <small>Define the conversational context and key vocabulary areas to focus on.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentVocab">Key Vocabulary Words</label>
                                    <textarea id="assignmentVocab" name="vocab" placeholder="e.g., men, camarero, cuenta, propina, delicioso, picante, bebida, postre, por favor, gracias" style="min-height: 80px;"></textarea>
                                    <small>Important words students should practice using (comma-separated). These will be tracked in their conversation logs.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="minVocabWords">Minimum Vocabulary Words Required</label>
                                    <input type="number" id="minVocabWords" name="min_vocab_words" min="0" max="20" step="1" value="0" placeholder="Number of vocabulary words students must use">
                                    <small>Set to 0 for no minimum requirement. Students will be tracked on how many unique vocabulary words they use.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Structure -->
                        <div class="wizard-step" data-step="5">
                            <div class="step-header">
                                <h2>Step 5: Structure - How should the conversation flow?</h2>
                                <p>Set duration, voice settings, and assignment logistics.</p>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignmentDuration">Conversation Duration</label>
                                        <input type="number" id="assignmentDuration" name="duration" min="1" max="60" step="1" value="5" required>
                                        <small>Minutes for the conversation. Shorter for beginners, longer for advanced students.</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="assignmentDueDate">Due Date (Optional)</label>
                                        <div class="date-picker-container">
                                            <div class="date-picker-input-wrapper">
                                                <div class="date-picker-label">Calendar</div>
                                                <div class="date-picker-input" onclick="toggleDatePicker()">
                                                    <input type="text" id="assignmentDueDateDisplay" readonly placeholder="Select date" class="date-display">
                                                    <!-- Hidden Date Picker -->
                                                    <div id="datePicker" class="date-picker" style="display: none;">
                                                        <div class="date-picker-header">
                                                            <button type="button" onclick="changeMonth(-1)" class="date-nav-btn"></button>
                                                            <span id="currentMonth">January 2024</span>
                                                            <button type="button" onclick="changeMonth(1)" class="date-nav-btn"></button>
                                                        </div>
                                                        <div class="date-picker-grid" id="datePickerGrid">
                                                            <!-- Calendar days will be generated here -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="time-picker-container">
                                                <div class="time-picker-input-wrapper">
                                                    <div class="time-picker-label">Clock</div>
                                                    <div style="position: relative;">
                                                        <input type="text" id="assignmentDueTimeDisplay" readonly placeholder="Select time" class="time-display" onclick="toggleTimePicker()">
                                                        <!-- Hidden Time Picker -->
                                                        <div id="timePicker" class="time-picker" style="display: none;">
                                                            <div class="time-picker-header">
                                                                <span id="timePickerTitle">Select Time</span>
                                                                <!-- AM/PM Toggle in Upper Right -->
                                                                <div class="time-period-toggle">
                                                                    <label class="toggle-switch-small">
                                                                        <input type="checkbox" id="amPmToggle" onchange="toggleAmPm()">
                                                                        <span class="toggle-slider-small"></span>
                                                                    </label>
                                                                    <span class="toggle-label-small" id="amPmLabel">AM</span>
                                                                </div>
                                                            </div>
                                                            <div class="time-picker-grid">
                                                                <!-- Hours -->
                                                                <div class="time-picker-section">
                                                                    <div class="time-picker-label">Hours</div>
                                                                    <div class="time-picker-hours" id="hoursGrid">
                                                                        <!-- Hours will be generated here -->
                                                                    </div>
                                                                </div>
                                                                <!-- Minutes -->
                                                                <div class="time-picker-section">
                                                                    <div class="time-picker-label">Minutes</div>
                                                                    <div class="time-picker-minutes" id="minutesGrid">
                                                                        <!-- Minutes will be generated here -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="date-clear-btn" onclick="clearDueDate()"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="assignmentClassroom">Classroom</label>
                                    <div class="custom-dropdown">
                                        <div class="dropdown-trigger" onclick="toggleDropdown('assignmentClassroomDropdown')">
                                            <span id="assignmentClassroomDisplay">Select Classroom</span>
                                            <div class="dropdown-arrow"></div>
                                        </div>
                                        <div class="dropdown-options" id="assignmentClassroomDropdown" style="display: none;">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                    <select id="assignmentClassroom" name="classroom_id" required style="display: none;">
                                        <option value="">Select Classroom</option>
                                    </select>
                                    <small>Assign this to a specific class of students.</small>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignmentVoiceSpeed">Voice Speed</label>
                                        <input type="range" id="assignmentVoiceSpeed" name="voice_speed" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 100%;">
                                        <div class="voice-speed-display">
                                            <span class="speed-label">Slower</span>
                                            <span class="speed-value" id="voiceSpeedValue">1.0x</span>
                                            <span class="speed-label">Faster</span>
                                        </div>
                                        <small>Adjust speech rate for learner comprehension.</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="assignmentSpeakSlowly" name="speak_slowly">
                                                <span>Speak Slowly & Clearly ("Hablar lento y claro")</span>
                                            </label>
                                        </div>
                                        <small>Avatar will speak more slowly and clearly for better comprehension.</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: Review -->
                        <div class="wizard-step" data-step="6">
                            <div class="step-header">
                                <h2>Step 6: Review & Create Assignment</h2>
                                <p>Review all your selections and create the assignment.</p>
                            </div>
                            
                            <div class="review-section">
                                <div class="review-grid">
                                    <div class="review-label">Avatar Role:</div>
                                    <div class="review-value" id="reviewRole">-</div>
                                    
                                    <div class="review-label">Student Objective:</div>
                                    <div class="review-value" id="reviewObjective">-</div>
                                    
                                    <div class="review-label">Proficiency Level:</div>
                                    <div class="review-value" id="reviewLevel">-</div>
                                    
                                    <div class="review-label">Assignment Title:</div>
                                    <div class="review-value" id="reviewTitle">-</div>
                                    
                                    <div class="review-label">Vocabulary Words:</div>
                                    <div class="review-value" id="reviewVocab">-</div>
                                    
                                    <div class="review-label">Voice Settings:</div>
                                    <div class="review-value" id="reviewVoice">-</div>
                                    
                                    <div class="review-label">Duration:</div>
                                    <div class="review-value" id="reviewDuration">-</div>
                                    
                                    <div class="review-label">Due Date:</div>
                                    <div class="review-value" id="reviewDueDate">-</div>
                                    
                                    <div class="review-label">Classroom:</div>
                                    <div class="review-value" id="reviewClassroom">-</div>
                                </div>
                            </div>
                            
                            <div class="review-actions">
                                <button type="button" class="btn btn-secondary" onclick="editStep(1)">Edit Persona</button>
                                <button type="button" class="btn btn-secondary" onclick="editStep(2)">Edit Act</button>
                                <button type="button" class="btn btn-secondary" onclick="editStep(3)">Edit Recipient</button>
                                <button type="button" class="btn btn-secondary" onclick="editStep(4)">Edit Theme</button>
                                <button type="button" class="btn btn-secondary" onclick="editStep(5)">Edit Structure</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Navigation Buttons -->
                <div class="wizard-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
                    <button type="submit" class="btn btn-primary" id="createBtn" style="display: none;" form="assignmentWizardForm">Create Assignment</button>
                </div>
            </div>
        </div>
        
        <!-- My Assignments Tab -->
        <div id="assignments-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">My Assignments</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="assignmentsToggleBtn" onclick="toggleAssignmentsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteSelectedAssignments()" style="background: #dc3545; color: white;">Delete Selected</button>
                </div>
            </div>
            <div class="assignments-list" id="assignmentsList">
                <!-- Assignments will be loaded here -->
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">Student Activity Logs</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="logsToggleBtn" onclick="toggleLogsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteSelectedLogs()" style="background: #dc3545; color: white;">Delete Selected</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAssignments">0</div>
                    <div class="stat-label">Total Assignments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Students Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgCompletion">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="voiceUsage">0%</div>
                    <div class="stat-label">Student Speaking Rate</div>
                </div>
            </div>
            
            <div class="logs-table">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllLogsCheckbox" onchange="toggleAllLogs()" style="width: 16px; height: 16px;"></th>
                            <th>Student</th>
                            <th>Assignment</th>
                            <th>Level</th>
                            <th>Date Assigned</th>
                            <th>Due Date</th>
                            <th>Submitted On Time</th>
                            <th>Messages</th>
                            <th>Vocabulary Used</th>
                            <th>Attempt Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Menu -->
    <div class="menu-overlay" onclick="closeMenu()"></div>
    <div class="sidebar-menu" id="sidebarMenu">
        <div class="sidebar-header">
            <h3>Menu</h3>
        </div>
        
        <div class="sidebar-content">
            <div class="menu-section">
                <h4>Quick Actions</h4>
                <a href="#" class="menu-item" onclick="switchTab('create'); closeMenu();">
                    <div class="menu-item-icon">+</div>
                    <span>Create Assignment</span>
                </a>
                <a href="#" class="menu-item" onclick="switchTab('classrooms'); closeMenu();">
                    <div class="menu-item-icon"></div>
                    <span>Classroom Management</span>
                </a>
                <a href="#" class="menu-item" onclick="switchTab('analytics'); closeMenu();">
                    <div class="menu-item-icon"></div>
                    <span>View Analytics</span>
                </a>
            </div>
            
            <div class="menu-section">
                <h4>Account Status</h4>
                <div class="account-status">
                    <h4>FREE TRIAL (FULL ACCESS)</h4>
                    <p>Expires: December 31, 2024</p>
                    <p>Students: <span id="menuStudentCount">0</span></p>
                </div>
            </div>
            
            <div class="menu-section">
                <h4>Navigation</h4>
                <a href="/" class="menu-item">
                    <div class="menu-item-icon"></div>
                    <span>Home</span>
                </a>
                <a href="#" class="menu-item" onclick="openProfileModal(); closeMenu();">
                    <div class="menu-item-icon"></div>
                    <span>Profile</span>
                </a>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <span></span>
                <span>Sign Out</span>
            </button>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Teacher Profile</h2>
                <span class="modal-close" onclick="closeProfileModal()"></span>
            </div>
            <div class="modal-body">
                <div id="profileContent">
                    <!-- Profile content will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button class="btn btn-primary" type="submit" form="profileForm">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Share Assignment Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Assignment</h2>
                <p>Share this link with your students</p>
            </div>
            <div class="share-link" id="shareLink"></div>
            <button class="copy-btn" onclick="copyShareLink()"> Copy Link</button>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Conversation Modal -->
    <div id="conversationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Conversation Transcript</h3>
                <button class="modal-close" onclick="closeConversationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="conversationHeader" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4 id="conversationTitle" style="margin: 0 0 5px 0; color: #333;">Loading...</h4>
                    <div id="conversationStats" style="display: flex; gap: 15px; margin-top: 8px; font-size: 14px; color: #666;">
                        <!-- Stats will be populated here -->
                    </div>
                    <div id="conversationMeta" style="margin-top: 8px; font-size: 12px; color: #64748b;">
                        <!-- Meta info will be populated here -->
                    </div>
                </div>
                <div id="conversationVocab" style="margin-top: 20px;">
                    <!-- Vocabulary usage will be displayed here -->
                </div>
                <div id="conversationContent">
                    <!-- Conversation will be loaded here -->
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeConversationModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Classroom Details Modal -->
    <div id="classroomDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Classroom Details</h2>
                <p id="classroomDetailsInfo">Loading classroom information...</p>
            </div>
            <div id="classroomDetailsContent" style="max-height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
                <!-- Classroom details will be loaded here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeClassroomDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Create Classroom Modal -->
    <div id="createClassroomModal" class="modal">
        <div class="modal-content classroom-modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2>Create New Classroom</h2>
                    <p>Set up a new classroom for your Spanish students</p>
                </div>
                <button class="modal-close-btn" onclick="closeCreateClassroomModal()"></button>
            </div>
            <form class="modal-form" onsubmit="createClassroom(event)">
                <div class="form-section">
                    <div class="section-title">Basic Information</div>
                    
                    <div class="form-group">
                        <label for="modalClassroomName">Classroom Name</label>
                        <input type="text" id="modalClassroomName" name="name" required placeholder="e.g., Spanish 101 - Fall 2024">
                        <small>Choose a descriptive name for your classroom</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="modalClassroomDescription">Description</label>
                        <textarea id="modalClassroomDescription" name="description" placeholder="Describe your classroom and learning objectives..." rows="3"></textarea>
                        <small>Help students understand what they'll learn in this class</small>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-title">Course Details</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalGradeLevel">Spanish Course Level</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-trigger" onclick="toggleDropdown('modalGradeLevelDropdown')">
                                    <span id="modalGradeLevelDisplay">Select Spanish Level</span>
                                    <div class="dropdown-arrow"></div>
                                </div>
                                <div class="dropdown-options" id="modalGradeLevelDropdown" style="display: none;">
                                    <div class="dropdown-option" data-value="Spanish 1">Spanish 1</div>
                                    <div class="dropdown-option" data-value="Spanish 2">Spanish 2</div>
                                    <div class="dropdown-option" data-value="Spanish 3">Spanish 3</div>
                                    <div class="dropdown-option" data-value="Spanish 4">Spanish 4</div>
                                    <div class="dropdown-option" data-value="Spanish 5">Spanish 5</div>
                                    <div class="dropdown-option" data-value="AP Spanish">AP Spanish</div>
                                </div>
                            </div>
                            <select id="modalGradeLevel" name="gradeLevel" style="display: none;">
                                <option value="">Select Spanish Level</option>
                                <option value="Spanish 1">Spanish 1</option>
                                <option value="Spanish 2">Spanish 2</option>
                                <option value="Spanish 3">Spanish 3</option>
                                <option value="Spanish 4">Spanish 4</option>
                                <option value="Spanish 5">Spanish 5</option>
                                <option value="AP Spanish">AP Spanish</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <div class="toggle-group">
                                <label class="toggle-label">Honors Level</label>
                                <div class="toggle-switch" id="modalAdvancedToggle" onclick="toggleModalAdvanced()"></div>
                                <small class="toggle-description">Check if this is an honors level course</small>
                            </div>
                            <input type="checkbox" id="modalAdvanced" name="advanced" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateClassroomModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">+</span>
                        Create Classroom
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Notification Modal -->
    <div id="notificationModal" class="notification-modal">
        <button class="notification-close" onclick="hideNotification()"></button>
        <div class="notification-title" id="notificationTitle">Success</div>
        <div class="notification-message" id="notificationMessage">Operation completed successfully</div>
    </div>
    
    <script>
        let assignments = [];
        let logs = [];
        let currentTeacher = null;
        let classrooms = [];
        
        // Wizard State Management
        let currentStep = 1;
        const totalSteps = 6;
        
        // Toggle menu functions
        function toggleMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.querySelector('.menu-overlay');
            const toggleBtn = document.querySelector('.menu-toggle-btn');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            toggleBtn.classList.toggle('active');
        }
        
        function closeMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.querySelector('.menu-overlay');
            const toggleBtn = document.querySelector('.menu-toggle-btn');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            toggleBtn.classList.remove('active');
        }
        
        // Profile modal functions
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('active');
            loadTeacherProfile();
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('active');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadOrCreateTeacher();
            loadActiveTab();
            
            // Initialize wizard
            initializeWizard();
            
            // Handle proficiency standard changes
            const standardSelect = document.getElementById('assignmentStandard');
            if (standardSelect) {
                standardSelect.addEventListener('change', function() {
                    loadProficiencyLevels();
                });
                // Set initial state
                loadProficiencyLevels();
            }
            
            // Handle voice speed slider
            const voiceSpeedSlider = document.getElementById('assignmentVoiceSpeed');
            const voiceSpeedValue = document.getElementById('voiceSpeedValue');
            if (voiceSpeedSlider && voiceSpeedValue) {
                voiceSpeedSlider.addEventListener('input', function() {
                    voiceSpeedValue.textContent = this.value + 'x';
                });
            }
        });
        
        // Wizard Functions
        function initializeWizard() {
            updateStepDisplay();
            updateNavigationButtons();
        }
        
        function updateStepDisplay() {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            
            // Update progress indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Update review step if on step 6
            if (currentStep === 6) {
                updateReviewStep();
            }
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const createBtn = document.getElementById('createBtn');
            
            // Show/hide previous button
            prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
            
            // Show/hide next vs create button
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                createBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                createBtn.style.display = 'none';
            }
        }
        
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateStepDisplay();
                    updateNavigationButtons();
                }
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
                updateNavigationButtons();
            }
        }
        
        function editStep(stepNumber) {
            currentStep = stepNumber;
            updateStepDisplay();
            updateNavigationButtons();
        }
        
        function validateCurrentStep() {
            const currentStepElement = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    // Find the label for this field
                    const label = field.previousElementSibling;
                    const fieldName = label ? label.textContent.replace(':', '').trim() : 'Required field';
                    
                    // Show nice validation notification
                    showValidationError(fieldName, field);
                    return false;
                }
            }
            
            return true;
        }
        
        function showValidationError(fieldName, field) {
            // Check if field has custom validation message
            const customMessage = field.getAttribute('data-validation-message');
            const messageText = customMessage || 'Please fill out this required section';
            
            // Create validation notification
            const notification = document.createElement('div');
            notification.className = 'validation-notification';
            notification.innerHTML = `
                <div class="validation-content">
                    <div class="validation-icon"></div>
                    <div class="validation-message">
                        <div class="validation-title">Missing Required Field</div>
                        <div class="validation-text">${messageText}</div>
                    </div>
                    <button class="validation-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Highlight the field
            field.style.borderColor = '#ef4444';
            field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            
            // Focus on the field
            field.focus();
            
            // Remove highlight when user starts typing
            field.addEventListener('input', function removeHighlight() {
                field.style.borderColor = '';
                field.style.boxShadow = '';
                field.removeEventListener('input', removeHighlight);
            });
            
            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
            
            // Remove notification when close button is clicked
            notification.querySelector('.validation-close').addEventListener('click', () => {
                notification.remove();
            });
        }
        
        function updateReviewStep() {
            const formData = new FormData(document.getElementById('assignmentWizardForm'));
            
            // Update review fields
            document.getElementById('reviewRole').textContent = formData.get('avatar_role') || '-';
            document.getElementById('reviewObjective').textContent = formData.get('student_objective') || '-';
            document.getElementById('reviewLevel').textContent = `${formData.get('level_standard')} - ${formData.get('level')}` || '-';
            document.getElementById('reviewTitle').textContent = formData.get('title') || '-';
            
            // Handle vocabulary
            const vocab = formData.get('vocab');
            document.getElementById('reviewVocab').textContent = vocab ? vocab.split(',').slice(0, 5).join(', ') + (vocab.split(',').length > 5 ? '...' : '') : '-';
            
            // Handle voice settings
            const voiceSettings = [];
            if (formData.get('voice_speed') !== '1.0') {
                voiceSettings.push(`Speed: ${formData.get('voice_speed')}x`);
            }
            if (formData.get('speak_slowly')) {
                voiceSettings.push('Speak slowly');
            }
            document.getElementById('reviewVoice').textContent = voiceSettings.length > 0 ? voiceSettings.join(', ') : 'Normal';
            
            document.getElementById('reviewDuration').textContent = formData.get('duration') ? `${formData.get('duration')} minutes` : '-';
            
            // Handle due date
            const dueDate = formData.get('due_date');
            const dueTime = formData.get('due_time');
            let dueDateDisplay = 'No due date';
            if (dueDate) {
                const date = new Date(dueDate);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                if (dueTime) {
                    dueDateDisplay = `${formattedDate} at ${dueTime}`;
                } else {
                    dueDateDisplay = formattedDate;
                }
            }
            document.getElementById('reviewDueDate').textContent = dueDateDisplay;
            
            // Get classroom name
            const classroomSelect = document.getElementById('assignmentClassroom');
            const selectedOption = classroomSelect.options[classroomSelect.selectedIndex];
            document.getElementById('reviewClassroom').textContent = selectedOption ? selectedOption.text : '-';
        }
        
        // Date picker functions
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDate = null;
        let selectedTime = null;
        
        // Toggle persona mode between dropdown and custom input
        function togglePersonaMode() {
            const checkbox = document.getElementById('useCustomAvatar');
            const dropdownContainer = document.getElementById('personaDropdownContainer');
            const customContainer = document.getElementById('customAvatarContainer');
            const hiddenSelect = document.getElementById('assignmentPersona');
            const customInput = document.getElementById('customPersona');
            
            if (checkbox.checked) {
                // Show custom input, hide dropdown
                dropdownContainer.classList.add('hidden');
                customContainer.style.display = 'block';
                hiddenSelect.value = 'custom';
                customInput.setAttribute('required', 'required');
                customInput.setAttribute('data-validation-message', 'Please fill out this required section');
            } else {
                // Show dropdown, hide custom input
                dropdownContainer.classList.remove('hidden');
                customContainer.style.display = 'none';
                hiddenSelect.value = '';
                customInput.removeAttribute('required');
                customInput.value = '';
            }
        }

        // Custom persona toggle function (deprecated - replaced by togglePersonaMode)
        function toggleCustomPersona() {
            const personaSelect = document.getElementById('assignmentPersona');
            const customInput = document.getElementById('customPersonaInput');
            
            if (personaSelect.value === 'custom') {
                customInput.style.display = 'block';
                // Make custom field required when custom is selected
                document.getElementById('customPersona').setAttribute('required', 'required');
            } else {
                customInput.style.display = 'none';
                // Remove required attribute when not custom
                document.getElementById('customPersona').removeAttribute('required');
                // Clear the custom field
                document.getElementById('customPersona').value = '';
            }
        }

        // Toggle custom avatar input field
        function toggleCustomAvatarInput() {
            const checkbox = document.getElementById('customAvatarCheckbox');
            const customInput = document.getElementById('customPersona');
            const customHint = document.getElementById('customPersona').nextElementSibling;
            
            if (checkbox.checked) {
                customInput.style.display = 'block';
                customHint.style.display = 'block';
                customInput.setAttribute('required', 'required');
            } else {
                customInput.style.display = 'none';
                customHint.style.display = 'none';
                customInput.removeAttribute('required');
                customInput.value = '';
            }
        }

        // Custom dropdown functionality
        function togglePersonaDropdown() {
            const dropdown = document.getElementById('personaOptions');
            const trigger = document.getElementById('personaDropdown');
            const triggerElement = trigger.querySelector('.dropdown-trigger');
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                triggerElement.classList.add('active');
            } else {
                dropdown.style.display = 'none';
                triggerElement.classList.remove('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('personaOptions');
            const trigger = document.getElementById('personaDropdown');
            
            if (!trigger.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
                trigger.querySelector('.dropdown-trigger').classList.remove('active');
            }
        });

        // Handle dropdown option selection
        function selectPersonaOption(value, text) {
            const dropdown = document.getElementById('personaOptions');
            const trigger = document.getElementById('personaDropdown');
            const triggerElement = trigger.querySelector('.dropdown-trigger');
            const display = triggerElement.querySelector('span');
            
            // Update display
            display.textContent = text;
            
            // Update hidden select
            const hiddenSelect = document.getElementById('assignmentPersona');
            hiddenSelect.value = value;
            
            // Close dropdown
            dropdown.style.display = 'none';
            triggerElement.classList.remove('active');
            
            // Update selected state
            const options = dropdown.querySelectorAll('.dropdown-option');
            options.forEach(option => {
                option.classList.toggle('selected', option.getAttribute('data-value') === value);
            });
        }

        // Universal dropdown functions for all other dropdowns
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const trigger = dropdown.previousElementSibling;
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-options').forEach(otherDropdown => {
                if (otherDropdown.id !== dropdownId) {
                    otherDropdown.style.display = 'none';
                    otherDropdown.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                trigger.classList.add('active');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('active');
            }
        }

        function selectDropdownOption(dropdownId, value, text) {
            console.log('selectDropdownOption called:', dropdownId, value, text);
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) {
                console.error('Dropdown not found:', dropdownId);
                return;
            }
            
            // Find the custom dropdown container (might be the dropdown itself or its parent)
            const customDropdown = dropdown.classList.contains('dropdown-options') ? 
                dropdown.parentElement : dropdown;
            
            const hiddenSelect = customDropdown.nextElementSibling;
            const display = customDropdown.querySelector('.dropdown-trigger span');
            
            console.log('Elements found - dropdown:', dropdown.id, 'customDropdown:', customDropdown.className, 'hiddenSelect:', hiddenSelect?.id, 'display:', display?.id);
            
            if (!hiddenSelect) {
                console.error('Hidden select not found for dropdown:', dropdownId);
                return;
            }
            
            if (!display) {
                console.error('Display element not found for dropdown:', dropdownId);
                return;
            }
            
            console.log('Updating display from:', display.textContent, 'to:', text);
            
            // Update display
            display.textContent = text;
            
            // Update hidden select
            hiddenSelect.value = value;
            
            // Close dropdown
            dropdown.style.display = 'none';
            dropdown.previousElementSibling.classList.remove('active');
            
            // Update selected state
            dropdown.querySelectorAll('.dropdown-option').forEach(option => {
                option.classList.toggle('selected', option.getAttribute('data-value') === value);
            });
        }

        // Initialize all dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize persona dropdown - SPECIFIC selector only
            const personaOptions = document.querySelectorAll('#personaOptions .dropdown-option');
            personaOptions.forEach(option => {
                option.addEventListener('click', function() {
                    selectPersonaOption(this.getAttribute('data-value'), this.textContent);
                });
            });
            
            // Proficiency Standard dropdown
            document.querySelectorAll('#assignmentStandardDropdown .dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectDropdownOption('assignmentStandardDropdown', this.getAttribute('data-value'), this.textContent);
                    // Trigger level loading when standard changes
                    setTimeout(() => loadProficiencyLevels(), 100); // Small delay to ensure DOM updates
                });
            });
            
            // Modal dropdowns
            document.querySelectorAll('#modalGradeLevelDropdown .dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectDropdownOption('modalGradeLevelDropdown', this.getAttribute('data-value'), this.textContent);
                });
            });
            
            document.querySelectorAll('#editAssignmentLevelDropdown .dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectDropdownOption('editAssignmentLevelDropdown', this.getAttribute('data-value'), this.textContent);
                });
            });
            
            // Click outside to close dropdowns
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.custom-dropdown')) {
                    document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                        dropdown.style.display = 'none';
                        dropdown.previousElementSibling.classList.remove('active');
                    });
                }
            });
        });

        function initializeDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.querySelectorAll('.dropdown-option').forEach(option => {
                    option.addEventListener('click', function() {
                        selectDropdownOption(dropdownId, this.getAttribute('data-value'), this.textContent);
                        
                        // Special handling for level dropdown to trigger validation
                        if (dropdownId === 'assignmentLevelDropdown') {
                            // Trigger any validation or other events needed
                            const event = new Event('change', { bubbles: true });
                            document.getElementById('assignmentLevel').dispatchEvent(event);
                        }
                    });
                });
            }
        }
        
        function toggleDatePicker() {
            const datePicker = document.getElementById('datePicker');
            const timePicker = document.getElementById('timePicker');
            
            // Close time picker if open
            if (timePicker.style.display !== 'none') {
                timePicker.style.display = 'none';
            }
            
            // Toggle date picker
            if (datePicker.style.display === 'none') {
                datePicker.style.display = 'block';
                generateCalendar();
                updateMonthDisplay();
            } else {
                datePicker.style.display = 'none';
            }
        }
        
        function toggleTimePicker() {
            const datePicker = document.getElementById('datePicker');
            const timePicker = document.getElementById('timePicker');
            
            // Close date picker if open
            if (datePicker.style.display !== 'none') {
                datePicker.style.display = 'none';
            }
            
            // Toggle time picker
            if (timePicker.style.display === 'none') {
                timePicker.style.display = 'block';
                generateTimeOptions();
            } else {
                timePicker.style.display = 'none';
            }
        }
        
        function generateCalendar() {
            const grid = document.getElementById('datePickerGrid');
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let html = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="day-header">${day}</div>`;
            });
            
            // Empty cells for first week
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="day other-month"></div>`;
            }
            
            // Days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const isToday = date.toDateString() === today.toDateString();
                const isOtherMonth = date.getMonth() !== currentMonth;
                const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
                
                let classes = 'day';
                if (isToday) classes += ' today';
                if (isOtherMonth) classes += ' other-month';
                if (isSelected) classes += ' selected';
                
                html += `<div class="${classes}" onclick="selectDate(${currentYear}, ${currentMonth}, ${day})">${day}</div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        }
        
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
            updateMonthDisplay();
        }
        
        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            updateDateDisplay();
            toggleDatePicker();
        }
        
        function updateDateDisplay() {
            const display = document.getElementById('assignmentDueDateDisplay');
            const timeDisplay = document.getElementById('assignmentDueTimeDisplay');
            
            if (selectedDate) {
                const options = { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                };
                display.value = selectedDate.toLocaleDateString('en-US', options);
            } else {
                display.value = '';
            }
            
            if (selectedTime) {
                timeDisplay.value = formatTime(selectedTime);
            } else {
                timeDisplay.value = '';
            }
        }
        
        function generateTimeOptions() {
            const hoursGrid = document.getElementById('hoursGrid');
            const minutesGrid = document.getElementById('minutesGrid');
            
            // Generate hours (1-12)
            let hourHtml = '';
            for (let hour = 1; hour <= 12; hour++) {
                const isSelected = selectedTime && get12Hour(selectedTime.getHours()) === hour;
                hourHtml += `<div class="time-option ${isSelected ? 'selected' : ''}" onclick="selectHour(${hour})">${hour}</div>`;
            }
            hoursGrid.innerHTML = hourHtml;
            
            // Generate minutes (0, 15, 30, 45)
            const minuteValues = [0, 15, 30, 45];
            let minuteHtml = '';
            minuteValues.forEach(minute => {
                const isSelected = selectedTime && selectedTime.getMinutes() === minute;
                minuteHtml += `<div class="time-option ${isSelected ? 'selected' : ''}" onclick="selectMinute(${minute})">${minute.toString().padStart(2, '0')}</div>`;
            });
            minutesGrid.innerHTML = minuteHtml;
            
            // Update AM/PM toggle state
            if (selectedTime) {
                const isPM = selectedTime.getHours() >= 12;
                const toggle = document.getElementById('amPmToggle');
                const label = document.getElementById('amPmLabel');
                toggle.checked = isPM;
                label.textContent = isPM ? 'PM' : 'AM';
            }
        }
        
        function get12Hour(hour24) {
            return hour24 % 12 || 12;
        }
        
        function toggleAmPm() {
            const toggle = document.getElementById('amPmToggle');
            const label = document.getElementById('amPmLabel');
            const isPM = toggle.checked;
            
            label.textContent = isPM ? 'PM' : 'AM';
            
            if (!selectedTime) {
                selectedTime = new Date();
                selectedTime.setHours(12, 0, 0, 0); // Default to 12:00
            }
            
            const currentHour = selectedTime.getHours();
            const current12Hour = get12Hour(currentHour);
            
            // Convert between AM/PM
            if (isPM && currentHour < 12) {
                selectedTime.setHours(current12Hour + 12);
            } else if (!isPM && currentHour >= 12) {
                selectedTime.setHours(current12Hour);
            }
            
            // Don't regenerate options to keep picker open, just update display
            updateTimeDisplay();
        }
        
        function selectHour(hour) {
            if (!selectedTime) {
                selectedTime = new Date();
                selectedTime.setHours(12, 0, 0, 0); // Default to 12:00
            }
            
            const isPM = document.getElementById('amPmToggle').checked;
            selectedTime.setHours(isPM && hour < 12 ? hour + 12 : hour);
            
            // Don't regenerate options to keep picker open, just update display
            updateHourSelection(hour);
            updateTimeDisplay();
        }
        
        function selectMinute(minute) {
            if (!selectedTime) {
                selectedTime = new Date();
                selectedTime.setHours(12, 0, 0, 0); // Default to 12:00
            }
            selectedTime.setMinutes(minute);
            
            // Don't regenerate options to keep picker open, just update display
            updateMinuteSelection(minute);
            updateTimeDisplay();
        }
        
        function updateHourSelection(selectedHour) {
            // Update only the hour selection without regenerating
            document.querySelectorAll('.time-picker-hours .time-option').forEach(option => {
                const hour = parseInt(option.textContent);
                option.classList.toggle('selected', hour === selectedHour);
            });
        }
        
        function updateMinuteSelection(selectedMinute) {
            // Update only the minute selection without regenerating
            document.querySelectorAll('.time-picker-minutes .time-option').forEach(option => {
                const minute = parseInt(option.textContent);
                option.classList.toggle('selected', minute === selectedMinute);
            });
        }
        
        function updateTimeDisplay() {
            if (selectedTime) {
                const display = document.getElementById('assignmentDueTimeDisplay');
                const hours = selectedTime.getHours();
                const minutes = selectedTime.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                display.value = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
        }
        
        // Add click outside to close functionality
        document.addEventListener('click', function(event) {
            const datePicker = document.getElementById('datePicker');
            const timePicker = document.getElementById('timePicker');
            const dateInput = document.getElementById('assignmentDueDateDisplay');
            const timeInput = document.getElementById('assignmentDueTimeDisplay');
            
            // Check if click is outside date picker and date input
            if (datePicker.style.display !== 'none' && 
                !datePicker.contains(event.target) && 
                !dateInput.contains(event.target)) {
                datePicker.style.display = 'none';
            }
            
            // Check if click is outside time picker and time input
            if (timePicker.style.display !== 'none' && 
                !timePicker.contains(event.target) && 
                !timeInput.contains(event.target)) {
                timePicker.style.display = 'none';
            }
        });
        
        function formatHour(hour) {
            const hour12 = hour % 12 || 12;
            const ampm = hour < 12 ? 'AM' : 'PM';
            return `${hour12}:00 ${ampm}`;
        }
        
        function formatTime(time) {
            const hours = time.getHours();
            const minutes = time.getMinutes();
            const ampm = hours < 12 ? 'AM' : 'PM';
            const hour12 = hours % 12 || 12;
            const minuteStr = minutes.toString().padStart(2, '0');
            return `${hour12}:${minuteStr} ${ampm}`;
        }
        
        function clearTime() {
            selectedTime = null;
            generateTimeOptions();
            updateDateDisplay();
        }
        
        function confirmTime() {
            updateDateDisplay();
            toggleTimePicker();
        }
        
        function clearDueDate() {
            selectedDate = null;
            selectedTime = null;
            updateDateDisplay();
            
            // Clear the hidden form fields
            document.getElementById('assignmentDueDateDisplay').value = '';
            document.getElementById('assignmentDueTimeDisplay').value = '';
        }
        
        function combineDateTimeForSubmission() {
            if (selectedDate) {
                const date = new Date(selectedDate);
                if (selectedTime) {
                    date.setHours(selectedTime.getHours());
                    date.setMinutes(selectedTime.getMinutes());
                }
                return date.toISOString();
            }
            return null;
        }
        
        // Load proficiency levels based on standard
        function loadProficiencyLevels() {
            console.log('Loading proficiency levels...');
            const standardSelect = document.getElementById('assignmentStandard');
            const levelSelect = document.getElementById('assignmentLevel');
            const levelDropdown = document.getElementById('assignmentLevelDropdown');
            const levelDisplay = document.getElementById('assignmentLevelDisplay');
            
            if (!standardSelect || !levelSelect || !levelDropdown || !levelDisplay) {
                console.error('Missing elements for level loading');
                return;
            }
            
            const standard = standardSelect.value;
            console.log('Selected standard:', standard);
            
            // Clear existing options
            levelSelect.innerHTML = '<option value="">Select Level</option>';
            levelDropdown.innerHTML = '';
            levelDisplay.textContent = 'Select Level';
            
            // Basic standard - only legacy options
            if (standard === 'Basic' || standard === '') {
                const basicOptions = [
                    { value: 'beginner', text: 'Beginner' },
                    { value: 'intermediate', text: 'Intermediate' },
                    { value: 'advanced', text: 'Advanced' }
                ];
                
                basicOptions.forEach(option => {
                    levelSelect.innerHTML += `<option value="${option.value}">${option.text}</option>`;
                    levelDropdown.innerHTML += `<div class="dropdown-option" data-value="${option.value}">${option.text}</div>`;
                });
            }
            
            // ACTFL standard - specific ACTFL levels
            else if (standard === 'ACTFL') {
                const actflOptions = [
                    { value: 'novice_low', text: 'Novice Low' },
                    { value: 'novice_mid', text: 'Novice Mid' },
                    { value: 'novice_high', text: 'Novice High' },
                    { value: 'intermediate_low', text: 'Intermediate Low' },
                    { value: 'intermediate_mid', text: 'Intermediate Mid' },
                    { value: 'intermediate_high', text: 'Intermediate High' },
                    { value: 'advanced_low', text: 'Advanced Low' },
                    { value: 'advanced_mid', text: 'Advanced Mid' },
                    { value: 'advanced_high', text: 'Advanced High' },
                    { value: 'superior', text: 'Superior' },
                    { value: 'distinguished', text: 'Distinguished' }
                ];
                
                actflOptions.forEach(option => {
                    levelSelect.innerHTML += `<option value="${option.value}">${option.text}</option>`;
                    levelDropdown.innerHTML += `<div class="dropdown-option" data-value="${option.value}">${option.text}</div>`;
                });
            }
            
            // CEFR standard - specific CEFR levels
            else if (standard === 'CEFR') {
                const cefrOptions = [
                    { value: 'a1', text: 'A1 (Beginner)' },
                    { value: 'a2', text: 'A2 (Elementary)' },
                    { value: 'b1', text: 'B1 (Intermediate)' },
                    { value: 'b2', text: 'B2 (Upper Intermediate)' },
                    { value: 'c1', text: 'C1 (Advanced)' },
                    { value: 'c2', text: 'C2 (Proficient)' }
                ];
                
                cefrOptions.forEach(option => {
                    levelSelect.innerHTML += `<option value="${option.value}">${option.text}</option>`;
                    levelDropdown.innerHTML += `<div class="dropdown-option" data-value="${option.value}">${option.text}</div>`;
                });
            }
            
            console.log('Level dropdown HTML:', levelDropdown.innerHTML);
            
            // Reinitialize the level dropdown
            initializeDropdown('assignmentLevelDropdown');
            console.log('Level dropdown initialized');
        }
        
        // Monitor avatar dropdown changes
        const avatarDisplay = document.getElementById('selectedPersona');
        if (avatarDisplay) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    console.log('Avatar display changed from:', mutation.oldValue, 'to:', avatarDisplay.textContent);
                    console.trace('Avatar change stack trace');
                });
            });
            
            observer.observe(avatarDisplay, {
                childList: true,
                characterData: true,
                subtree: true,
                characterDataOldValue: true
            });
        }
        function clearWizardForm() {
            const form = document.getElementById('assignmentWizardForm');
            if (form) {
                form.reset();
                
                // Reset dropdown displays
                document.getElementById('selectedPersona').textContent = 'Choose a persona...';
                document.getElementById('assignmentStandardDisplay').textContent = 'Select Standard';
                document.getElementById('assignmentLevelDisplay').textContent = 'Select Level';
                document.getElementById('assignmentClassroomDisplay').textContent = 'Select Classroom';
                
                // Reset hidden selects
                document.getElementById('assignmentPersona').value = '';
                document.getElementById('assignmentStandard').value = '';
                document.getElementById('assignmentLevel').value = '';
                document.getElementById('assignmentClassroom').value = '';
                
                // Reset level dropdown to basic options
                loadProficiencyLevels();
                
                console.log('Wizard form cleared');
            }
        }
        function showNotification(title, message, type = 'success') {
            const modal = document.getElementById('notificationModal');
            const titleElement = document.getElementById('notificationTitle');
            const messageElement = document.getElementById('notificationMessage');
            
            // Set content
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Set type
            modal.className = 'notification-modal ' + type;
            
            // Show notification
            setTimeout(() => {
                modal.classList.add('show');
            }, 100);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        function hideNotification() {
            const modal = document.getElementById('notificationModal');
            modal.classList.remove('show');
        }
        
        // Replace alert calls with custom notifications
        function showAlert(message, type = 'success') {
            showNotification(type === 'error' ? 'Error' : 'Success', message, type);
        }
        
        // Teacher management
        async function loadOrCreateTeacher() {
            const savedTeacher = sessionStorage.getItem('currentTeacher');
            if (savedTeacher) {
                currentTeacher = JSON.parse(savedTeacher);
                console.log('Loaded teacher from sessionStorage:', currentTeacher.name, currentTeacher.id);
            } else {
                console.log('No teacher found in sessionStorage, redirecting to login');
                // Redirect to login page
                window.location.href = '/teacher-login';
                return;
            }
            
            if (currentTeacher) {
                console.log('Teacher loaded, loading classrooms...');
                loadClassrooms();
                loadClassroomSelect();
            }
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('currentTeacher');
            window.location.href = '/';
        }
        
        // Load data from server
        async function loadData() {
            try {
                // Load assignments from server
                const assignmentsResponse = await fetch('/api/assignments');
                const assignmentsData = await assignmentsResponse.json();
                assignments = assignmentsData.assignments || [];
                
                // Load logs from server
                const logsResponse = await fetch('/api/logs');
                const logsData = await logsResponse.json();
                logs = logsData.logs || [];
                
                console.log('Loaded from server:', { assignments: assignments.length, logs: logs.length });
            } catch (error) {
                console.error('Error loading data from server:', error);
                // Fallback to localStorage
                const savedAssignments = localStorage.getItem('assignments');
                const savedLogs = localStorage.getItem('logs');
                
                if (savedAssignments) {
                    assignments = JSON.parse(savedAssignments);
                }
                
                if (savedLogs) {
                    logs = JSON.parse(savedLogs);
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('assignments', JSON.stringify(assignments));
            localStorage.setItem('logs', JSON.stringify(logs));
        }
        
        // Save active tab to localStorage
        function saveActiveTab(tabName) {
            localStorage.setItem('activeTab', tabName);
        }
        
        // Load active tab from localStorage
        function loadActiveTab() {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && ['classrooms', 'create', 'assignments', 'analytics'].includes(savedTab)) {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to saved tab and content
                document.querySelector(`[onclick="switchTab('${savedTab}')"]`).classList.add('active');
                document.getElementById(`${savedTab}-tab`).classList.add('active');
                
                // Load tab-specific data
                if (savedTab === 'classrooms') {
                    loadClassrooms();
                } else if (savedTab === 'assignments') {
                    loadAssignments();
                } else if (savedTab === 'analytics') {
                    loadAnalytics();
                }
            }
        }
        
        // Switch between tabs
        async function switchTab(tabName) {
            console.log('=== TAB SWITCH DEBUG ===');
            console.log('Switching to tab:', tabName);
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Save active tab
            localStorage.setItem('activeTab', tabName);
            
            // Load tab-specific content
            if (tabName === 'create') {
                console.log('Loading create tab content');
                // Form is already clean when switching to create tab
                // No need to reset as it's always fresh
            } else if (tabName === 'assignments') {
                console.log('Loading assignments tab...');
                await loadAssignments();
            } else if (tabName === 'analytics') {
                console.log('Loading analytics tab...');
                await loadAnalytics();
            } else if (tabName === 'profile') {
                console.log('Loading profile tab...');
                // Profile is already loaded
            }
        }
        
        // Teacher profile functions
        async function loadTeacherProfile() {
            if (!currentTeacher) return;
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}`);
                const data = await response.json();
                const teacher = data.teacher;
                
                // Populate modal content
                const profileContent = document.getElementById('profileContent');
                profileContent.innerHTML = `
                    <form id="profileForm" onsubmit="updateTeacherProfile(event)" style="display: grid; gap: 24px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fef3f2 0%, #fef9f3 100%); border-radius: 12px; border: 1px solid #fed7aa;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #ea580c; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Name</label>
                                <input type="text" name="name" value="${teacher.name || ''}" style="width: 100%; max-width: 300px; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 18px; font-weight: 600; color: #0f172a; text-align: center; background: white; transition: all 0.2s ease;" placeholder="Your Name">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #ea580c; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Title</label>
                                <input type="text" name="title" value="${teacher.title || ''}" style="width: 100%; max-width: 300px; padding: 8px 14px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; color: #6b7280; text-align: center; background: white; transition: all 0.2s ease;" placeholder="Teacher">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: #ea580c; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">School</label>
                                <input type="text" name="school" value="${teacher.school || ''}" style="width: 100%; max-width: 300px; padding: 8px 14px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; color: #6b7280; text-align: center; background: white; transition: all 0.2s ease;" placeholder="School Name">
                            </div>
                            <div>
                                <label style="display: block; color: #ea580c; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Email</label>
                                <input type="email" name="email" value="${teacher.email || ''}" readonly style="width: 100%; max-width: 300px; padding: 8px 14px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; color: #374151; text-align: center; background: #f8fafc; cursor: not-allowed; transition: all 0.2s ease;" placeholder="email@example.com">
                                <p style="font-size: 11px; color: #6b7280; text-align: center; margin-top: 4px; font-style: italic;">Email cannot be changed - contact support if needed</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #0f172a; margin-bottom: 12px; font-size: 16px; font-weight: 600;">About</h4>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <textarea name="bio" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; color: #4a5568; line-height: 1.6; background: white; resize: vertical; transition: all 0.2s ease;" placeholder="Tell us about yourself...">${teacher.bio || ''}</textarea>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #0f172a; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Account Information</h4>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <span style="color: #6b7280; font-size: 14px; font-weight: 500;">Account Type</span>
                                    <span style="color: #ea580c; font-weight: 600;">Free Trial</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <span style="color: #6b7280; font-size: 14px; font-weight: 500;">Member Since</span>
                                    <span style="color: #374151; font-weight: 500;">${new Date(teacher.created_at || Date.now()).toLocaleDateString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <span style="color: #6b7280; font-size: 14px; font-weight: 500;">Total Students</span>
                                    <span style="color: #374151; font-weight: 500;">${classrooms.reduce((total, classroom) => total + (classroom.students ? classroom.students.length : 0), 0)}</span>
                                </div>
                            </div>
                        </div>
                    </form>
                `;
            } catch (error) {
                console.error('Error loading teacher profile:', error);
                const profileContent = document.getElementById('profileContent');
                profileContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>Error loading profile information. Please try again.</p>
                    </div>
                `;
            }
        }
        
        async function updateTeacherProfile(event) {
            event.preventDefault();
            
            if (!currentTeacher) {
                showNotification('Error', 'Teacher not found', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            
            // Debug what's being updated
            console.log('=== TEACHER PROFILE UPDATE DEBUG ===');
            console.log('Current teacher email:', currentTeacher.email);
            console.log('New email from form:', formData.get('email'));
            console.log('Form data:', {
                name: formData.get('name'),
                email: formData.get('email'),
                school: formData.get('school'),
                title: formData.get('title'),
                bio: formData.get('bio')
            });
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        school: formData.get('school'),
                        title: formData.get('title'),
                        bio: formData.get('bio')
                    })
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (response.ok) {
                    // Update current teacher data
                    currentTeacher = data.teacher;
                    localStorage.setItem('currentTeacher', JSON.stringify(currentTeacher));
                    console.log('Updated teacher data:', currentTeacher);
                    
                    showNotification('Success', 'Profile updated successfully!', 'success');
                } else {
                    showNotification('Error', 'Error updating profile: ' + data.detail, 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error', 'Error updating profile', 'error');
            }
        }
        
        // Classroom management functions
        async function loadClassrooms() {
            if (!currentTeacher) {
                console.log('No current teacher found');
                return;
            }
            
            console.log('Loading classrooms for teacher:', currentTeacher.id);
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}/classrooms`);
                const data = await response.json();
                console.log('Classrooms response:', data);
                classrooms = data.classrooms || [];
                console.log('Classrooms loaded:', classrooms);
                displayClassrooms();
            } catch (error) {
                console.error('Error loading classrooms:', error);
                classrooms = [];
                displayClassrooms();
            }
        }
        
        async function loadClassroomSelect() {
            try {
                if (!currentTeacher || !currentTeacher.id) {
                    console.error('No teacher found for classroom loading');
                    return;
                }
                
                const response = await fetch(`/api/teachers/${currentTeacher.id}/classrooms`);
                const data = await response.json();
                const classrooms = data.classrooms || [];
                
                const select = document.getElementById('assignmentClassroom');
                const dropdown = document.getElementById('assignmentClassroomDropdown');
                const display = document.getElementById('assignmentClassroomDisplay');
                
                if (select && dropdown && display) {
                    select.innerHTML = '<option value="">Select Classroom</option>' +
                        classrooms.map(classroom => 
                            `<option value="${classroom.id}">${classroom.name}</option>`
                        ).join('');
                        
                    dropdown.innerHTML = classrooms.map(classroom => 
                        `<div class="dropdown-option" data-value="${classroom.id}">${classroom.name}</div>`
                    ).join('');
                        
                    // Reinitialize the classroom dropdown
                    initializeDropdown('assignmentClassroomDropdown');
                } else {
                    console.error('Classroom dropdown elements not found');
                }
                
            } catch (error) {
                console.error('Error loading classroom select:', error);
            }
        }
        
        function displayClassrooms() {
            const container = document.getElementById('classroomsGrid');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            const deleteBtn = document.getElementById('deleteSelectedClassroomsBtn');
            
            if (classrooms.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No classrooms yet</h3>
                        <p>Create your first classroom to get started</p>
                    </div>
                `;
                // Hide buttons when no classrooms
                toggleBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                return;
            }
            
            // Show buttons when classrooms exist
            toggleBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-block';
            toggleBtn.textContent = 'Select All';
            
            container.innerHTML = classrooms.map(classroom => {
                let levelInfo = '';
                // Use spanish_level if available, otherwise fall back to subject
                const level = classroom.spanish_level || classroom.subject;
                if (level) {
                    levelInfo = level;
                    // Handle both boolean and number types for is_advanced
                    if (classroom.is_advanced === true || classroom.is_advanced === 1) {
                        levelInfo += ' (Honors)';
                    }
                }
                
                return `
                    <div class="classroom-card">
                        <input type="checkbox" class="classroom-checkbox" value="${classroom.id}" onchange="updateClassroomsToggleBtn()">
                        <div class="classroom-header">
                            <div class="classroom-title">${classroom.name}</div>
                            <div class="classroom-meta">
                                <span class="join-code">${classroom.join_code}</span>
                                ${levelInfo ? `<span>${levelInfo}</span>` : ''}
                            </div>
                        </div>
                        ${classroom.description ? `<div class="classroom-description">${classroom.description}</div>` : ''}
                        <div class="classroom-stats">
                            <div class="stat-item">
                                <div class="stat-number">${classroom.student_count || 0}</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${classroom.assignment_count || 0}</div>
                                <div class="stat-label">Assignments</div>
                            </div>
                        </div>
                        <div class="classroom-actions">
                            <button class="btn btn-primary btn-small" onclick="viewClassroom('${classroom.id}')">View Details</button>
                            <button class="btn btn-secondary btn-small" onclick="copyJoinCode('${classroom.join_code}')">Copy Code</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleModalAdvanced() {
            const toggle = document.getElementById('modalAdvancedToggle');
            const checkbox = document.getElementById('modalAdvanced');
            
            toggle.classList.toggle('active');
            checkbox.checked = toggle.classList.contains('active');
        }
        
        function showCreateClassroomModal() {
            document.getElementById('createClassroomModal').classList.add('active');
        }
        
        function closeCreateClassroomModal() {
            document.getElementById('createClassroomModal').classList.remove('active');
            // Reset form
            document.querySelector('#createClassroomModal form').reset();
            // Reset toggle
            const toggle = document.getElementById('modalAdvancedToggle');
            const checkbox = document.getElementById('modalAdvanced');
            toggle.classList.remove('active');
            checkbox.checked = false;
        }
        
        async function createClassroom(event) {
            event.preventDefault();
            
            if (!currentTeacher) {
                alert('Please set up teacher account first');
                return;
            }
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`/api/classrooms?teacher_id=${currentTeacher.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        description: formData.get('description'),
                        grade_level: '',
                        subject: formData.get('gradeLevel'),
                        spanish_level: formData.get('gradeLevel'),
                        is_advanced: formData.get('advanced') === 'on'
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showNotification('Success', 'Classroom created successfully!', 'success');
                    closeCreateClassroomModal();
                    loadClassrooms();
                    loadClassroomSelect();
                } else {
                    console.error('Server response:', data);
                    showNotification('Error', 'Error creating classroom: ' + (data.detail || data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error creating classroom:', error);
                showNotification('Error', 'Error creating classroom: ' + error.message, 'error');
            }
        }
        
        function copyJoinCode(joinCode) {
            navigator.clipboard.writeText(joinCode).then(() => {
                showNotification('Success', 'Join code copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Error', 'Failed to copy join code', 'error');
            });
        }
        
        async function viewClassroom(classroomId) {
            const classroom = classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            // Show modal
            document.getElementById('classroomDetailsModal').classList.add('active');
            
            // Update header info
            let levelInfo = '';
            // Use spanish_level if available, otherwise fall back to subject
            const level = classroom.spanish_level || classroom.subject;
            if (level) {
                levelInfo = level;
                // Handle both boolean and number types for is_advanced
                if (classroom.is_advanced === true || classroom.is_advanced === 1) {
                    levelInfo += ' (Honors)';
                }
            }
            
            document.getElementById('classroomDetailsInfo').innerHTML = `
                <strong>${classroom.name}</strong>  ${classroom.join_code}
                ${levelInfo ? `  ${levelInfo}` : ''}
            `;
            
            try {
                const response = await fetch(`/api/classrooms/${classroomId}/students`);
                const data = await response.json();
                const students = data.students || [];
                
                // Load classroom details content
                const content = document.getElementById('classroomDetailsContent');
                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Classroom Information</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Join Code</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${classroom.join_code}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Total Students</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${students.length}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Assignments</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${classroom.assignment_count || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${classroom.description ? `
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Description</h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <p style="color: #4a5568; line-height: 1.6; margin: 0;">${classroom.description}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Enrolled Students (${students.length})</h3>
                            <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                                ${students.length === 0 ? 
                                    '<div style="padding: 20px; text-align: center; color: #64748b;">No students enrolled yet</div>' :
                                    students.map(student => `
                                        <div style="padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #2d3748;">${student.name}</div>
                                                ${student.email ? `<div style="font-size: 13px; color: #64748b;">${student.email}</div>` : ''}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                ${student.grade_level ? `<span style="background: #f8fafc; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #64748b;">${student.grade_level}</span>` : ''}
                                                <span style="background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Enrolled</span>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading classroom details:', error);
                document.getElementById('classroomDetailsContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>Error loading classroom details</p>
                    </div>
                `;
            }
        }
        
        function closeClassroomDetailsModal() {
            document.getElementById('classroomDetailsModal').classList.remove('active');
        }
        
        // Classroom selection functions
        function toggleClassroomsSelection() {
            const checkboxes = document.querySelectorAll('.classroom-checkbox');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            const selectAll = toggleBtn.textContent === 'Select All';
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            toggleBtn.textContent = selectAll ? 'Deselect All' : 'Select All';
        }
        
        function updateClassroomsToggleBtn() {
            const checkboxes = document.querySelectorAll('.classroom-checkbox');
            const checkedBoxes = document.querySelectorAll('.classroom-checkbox:checked');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            
            if (checkboxes.length === 0) return;
            
            if (checkedBoxes.length === 0) {
                toggleBtn.textContent = 'Select All';
            } else if (checkedBoxes.length === checkboxes.length) {
                toggleBtn.textContent = 'Deselect All';
            } else {
                toggleBtn.textContent = 'Select All';
            }
        }
        
        async function deleteSelectedClassrooms() {
            const checkedBoxes = document.querySelectorAll('.classroom-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                showNotification('Warning', 'Please select at least one classroom to delete', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} classroom(s)? This will also delete all assignments and student enrollments.`)) {
                return;
            }
            
            const classroomIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            try {
                const deletePromises = classroomIds.map(async (classroomId, index) => {
                    const response = await fetch(`/api/classrooms/${classroomId}`, { method: 'DELETE' });
                    return { classroomId, response, index };
                });
                
                const results = await Promise.all(deletePromises);
                
                const successful = results.filter(r => r.response.ok);
                const failed = results.filter(r => !r.response.ok);
                
                if (failed.length === 0) {
                    showNotification('Success', `${classroomIds.length} classroom(s) deleted successfully`, 'success');
                    loadClassrooms();
                    loadClassroomSelect();
                } else {
                    const failedDetails = failed.map(f => {
                        const statusText = f.response.status;
                        const errorText = f.response.status === 404 ? 'Classroom not found' : 'Server error';
                        return `Classroom ${classroomIds[f.index]}: ${statusText} - ${errorText}`;
                    }).join('\n');
                    
                    showNotification('Error', `Some classrooms could not be deleted:\n\n${failedDetails}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting classrooms:', error);
                showNotification('Error', 'Error deleting classrooms: ' + error.message, 'error');
            }
        }
        
        // Create assignment (Wizard version)
        async function createAssignment(event) {
            event.preventDefault();
            
            console.log('=== CREATE ASSIGNMENT DEBUG ===');
            
            const formData = new FormData(event.target);
            const vocabText = formData.get('vocab') || '';
            const vocabList = vocabText.split(',').map(v => v.trim()).filter(v => v.length > 0);
            
            // Get avatar characteristics checkboxes
            const characteristics = [];
            document.querySelectorAll('input[name="avatar_characteristics"]:checked').forEach(checkbox => {
                characteristics.push(checkbox.value);
            });
            
            // Handle custom avatar role
            let avatarRole = formData.get('avatar_role');
            if (avatarRole === 'custom') {
                avatarRole = formData.get('custom_avatar_role');
                console.log('Using custom avatar role:', avatarRole);
            }
            
            // Combine date and time for due date
            const dueDate = combineDateTimeForSubmission();
            
            console.log('Form data being submitted:');
            console.log('  classroom_id:', formData.get('classroom_id'));
            console.log('  title:', formData.get('title'));
            console.log('  description:', formData.get('description'));
            console.log('  instructions:', formData.get('instructions'));
            console.log('  level:', formData.get('level'));
            console.log('  level_standard:', formData.get('level_standard'));
            console.log('  duration:', formData.get('duration'));
            console.log('  due_date:', dueDate);
            console.log('  vocab:', vocabList);
            console.log('  avatar_role:', avatarRole);
            console.log('  student_objective:', formData.get('student_objective'));
            console.log('  avatar_characteristics:', characteristics);
            console.log('  voice_speed:', formData.get('voice_speed'));
            console.log('  speak_slowly:', formData.get('speak_slowly'));
            console.log('  theme:', formData.get('theme'));
            
            const payload = {
                classroom_id: formData.get('classroom_id'),
                title: formData.get('title'),
                description: formData.get('description'),
                instructions: formData.get('instructions'),
                level: formData.get('level'),
                level_standard: formData.get('level_standard'),
                duration: parseInt(formData.get('duration')),
                due_date: dueDate,
                vocab: vocabList,
                min_vocab_words: parseInt(formData.get('min_vocab_words')) || 0,
                avatar_role: avatarRole,
                student_objective: formData.get('student_objective'),
                avatar_characteristics: characteristics,
                voice_speed: parseFloat(formData.get('voice_speed')),
                speak_slowly: formData.get('speak_slowly') === 'on',
                theme: formData.get('theme')
            };
            
            console.log('Full payload:', JSON.stringify(payload, null, 2));
            
            try {
                console.log('Sending request to /api/classroom-assignments...');
                const response = await fetch('/api/classroom-assignments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    console.log('Assignment created successfully!');
                    // Reset wizard to step 1
                    currentStep = 1;
                    updateStepDisplay();
                    updateNavigationButtons();
                    event.target.reset();
                    
                    // Show success message
                    showNotification('Success!', 'Assignment created successfully!');
                    
                    // Switch to assignments tab
                    setTimeout(() => {
                        console.log('Switching to assignments tab...');
                        document.querySelector('[data-tab="assignments"]').click();
                    }, 1500);
                } else {
                    console.error('Server error:', data);
                    showNotification('Error', data.detail || 'Failed to create assignment', 'error');
                }
            } catch (error) {
                console.error('Network error:', error);
                showNotification('Error', 'Failed to create assignment', 'error');
            }
        }
        
        // Recalculate assignment statistics from logs
        function recalculateAssignmentStats() {
            assignments.forEach(assignment => {
                // Get all logs for this assignment
                const assignmentLogs = logs.filter(log => log.assignmentId === assignment.id);
                
                // Count unique students
                const uniqueStudents = new Set(assignmentLogs.map(log => log.studentName));
                assignment.studentCount = uniqueStudents.size;
                
                // Count completed sessions
                assignment.completionCount = assignmentLogs.filter(log => log.completed).length;
            });
            
            saveData();
        }
        
        // Load assignments
        async function loadAssignments() {
            if (!currentTeacher) {
                console.log('No current teacher found');
                document.getElementById('assignmentsList').innerHTML = `
                    <div class="empty-state">
                        <h3>No teacher logged in</h3>
                        <p>Please log in to view assignments</p>
                    </div>
                `;
                return;
            }
            
            console.log('Loading assignments for teacher:', currentTeacher.id, currentTeacher.name);
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}/assignments`);
                console.log('API response status:', response.status);
                const data = await response.json();
                console.log('Assignments response:', data);
                assignments = data.assignments || [];
                console.log('Assignments loaded:', assignments.length);
                displayAssignments();
            } catch (error) {
                console.error('Error loading assignments:', error);
                assignments = [];
                displayAssignments();
            }
        }
        
        function displayAssignments() {
            const container = document.getElementById('assignmentsList');
            
            console.log('=== DISPLAY ASSIGNMENTS DEBUG ===');
            console.log('Total assignments to display:', assignments.length);
            console.log('Assignments data:', assignments);
            
            if (assignments.length === 0) {
                console.log('No assignments found, showing empty state');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No assignments yet</h3>
                        <p>Create your first assignment to get started</p>
                    </div>
                `;
                // Reset toggle button
                const toggleBtn = document.getElementById('assignmentsToggleBtn');
                if (toggleBtn) toggleBtn.textContent = 'Select All';
                return;
            }
            
            console.log('Rendering assignment cards...');
            container.innerHTML = assignments.map(assignment => {
                const studentText = assignment.completion_count === 1 ? 'student' : 'students';
                console.log('Rendering assignment:', assignment.title, 'ID:', assignment.id);
                return `
                <div class="assignment-card">
                    <div class="assignment-header">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="checkbox" class="assignment-checkbox" value="${assignment.id}" onchange="updateAssignmentsToggleBtn()">
                                <div>
                                    <div class="assignment-title">${assignment.title}</div>
                                    <div class="assignment-meta">
                                        <span> ${assignment.duration} min</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                                <span class="level-badge level-${assignment.level}">${assignment.level}</span>
                                <span style="font-size: 12px; color: #6b7280;">${assignment.completion_count} ${studentText} completed</span>
                            </div>
                        </div>
                    </div>
                    <div class="assignment-actions">
                        <button class="btn btn-primary btn-small" onclick="shareAssignment('${assignment.id}')">Share</button>
                        <button class="btn btn-secondary btn-small" onclick="viewAssignmentLogs('${assignment.id}')">View Logs</button>
                        <button class="btn btn-secondary btn-small" onclick="editAssignment('${assignment.id}')">Edit</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteAssignment('${assignment.id}')">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
            
            // Reset toggle button text
            const toggleBtn = document.getElementById('assignmentsToggleBtn');
            if (toggleBtn) toggleBtn.textContent = 'Select All';
        }
        
        // Update assignments toggle button text based on checkbox states
        function updateAssignmentsToggleBtn() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            if (allChecked && checkboxes.length > 0) {
                button.textContent = 'Deselect All';
            } else {
                button.textContent = 'Select All';
            }
        }
        
        // Share assignment
        function shareAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            const shareUrl = `${window.location.origin}/student?assignment=${assignmentId}`;
            document.getElementById('shareLink').textContent = shareUrl;
            document.getElementById('shareModal').classList.add('active');
        }
        
        // Copy share link
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(shareLink).then(() => {
                alert('Link copied to clipboard!');
            });
        }
        
        // Close share modal
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }
        
        // View assignment logs
        function viewAssignmentLogs(assignmentId) {
            // Switch to analytics tab
            document.querySelector('[onclick="switchTab(\'analytics\')"]').click();
            
            // Wait for tab to switch, then filter logs
            setTimeout(() => {
                filterLogsByAssignment(assignmentId);
            }, 100);
        }
        
        // Filter logs by specific assignment
        function filterLogsByAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            // Filter logs for this assignment only
            const assignmentLogs = logs.filter(log => log.assignmentId === assignmentId);
            
            // Update the logs table with filtered results
            const container = document.getElementById('logsContainer');
            if (assignmentLogs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No student submissions yet</h3>
                        <p>No students have completed this assignment yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">Student Submissions for: ${assignment.title}</h3>
                <div class="logs-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllLogsCheckbox" onchange="toggleLogsSelection()"></th>
                                <th>Student Name</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Messages</th>
                                <th>Voice Used</th>
                                <th>Vocabulary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignmentLogs.map(log => {
                                const startTime = new Date(log.startTime).toLocaleString();
                                const endTime = log.endTime ? new Date(log.endTime).toLocaleString() : 'In Progress';
                                const duration = log.endTime ? 
                                    Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) + ' min' : 
                                    'In Progress';
                                
                                const vocabDisplay = log.usedVocab && log.usedVocab.length > 0 ? 
                                    log.usedVocab.slice(0, 3).join(', ') + (log.usedVocab.length > 3 ? '...' : '') : 
                                    'None';
                                
                                return `
                                    <tr>
                                        <td><input type="checkbox" class="log-checkbox" value="${log.assignmentId}-${log.studentName}-${log.startTime}" style="width: 16px; height: 16px;" onchange="updateLogsToggleBtn()"></td>
                                        <td>${log.studentName}</td>
                                        <td>${startTime}</td>
                                        <td>${duration}</td>
                                        <td>${log.messageCount || 0}</td>
                                        <td>${log.voiceUsed ? 'Yes' : 'No'}</td>
                                        <td>${vocabDisplay}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="viewConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}')">
                                                View Conversation
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Reset toggle button
            const toggleBtn = document.getElementById('logsToggleBtn');
            if (toggleBtn) toggleBtn.textContent = 'Select All';
        }
        
        // Edit assignment
        function editAssignment(assignmentId) {
            console.log('editAssignment called with ID:', assignmentId);
            console.log('Available assignments:', assignments);
            
            const assignment = assignments.find(a => a.id === assignmentId);
            console.log('Found assignment:', assignment);
            
            if (!assignment) {
                console.error('Assignment not found with ID:', assignmentId);
                return;
            }
            
            console.log('Populating modal...');
            
            // Populate the edit modal with assignment data
            document.getElementById('editAssignmentId').value = assignment.id;
            document.getElementById('editAssignmentTitle').value = assignment.title;
            document.getElementById('editAssignmentLevel').value = assignment.level;
            document.getElementById('editAssignmentDuration').value = assignment.duration;
            document.getElementById('editAssignmentDueDate').value = assignment.due_date ? new Date(assignment.due_date).toISOString().slice(0, 16) : '';
            document.getElementById('editAssignmentPrompt').value = assignment.prompt;
            document.getElementById('editAssignmentDescription').value = assignment.description;
            document.getElementById('editAssignmentInstructions').value = assignment.instructions;
            document.getElementById('editAssignmentVocab').value = assignment.vocab ? assignment.vocab.join(', ') : '';
            document.getElementById('editMinVocabWords').value = assignment.min_vocab_words || 0;
            
            // Set classroom dropdown
            const classroomSelect = document.getElementById('editAssignmentClassroom');
            const classroomDropdown = document.getElementById('editAssignmentClassroomDropdown');
            const classroomDisplay = document.getElementById('editAssignmentClassroomDisplay');
            
            if (classroomSelect) {
                // Clear existing options
                classroomSelect.innerHTML = '<option value="">Select Classroom</option>';
                classroomDropdown.innerHTML = '';
                
                // Add classroom options
                classrooms.forEach(classroom => {
                    classroomSelect.innerHTML += `<option value="${classroom.id}">${classroom.name}</option>`;
                    classroomDropdown.innerHTML += `<div class="dropdown-option" data-value="${classroom.id}">${classroom.name}</div>`;
                });
                
                // Set current classroom
                classroomSelect.value = assignment.classroom_id || '';
                
                // Update display and dropdown selection
                const currentClassroom = classrooms.find(c => c.id === assignment.classroom_id);
                if (currentClassroom) {
                    classroomDisplay.textContent = currentClassroom.name;
                    // Update selected state in dropdown
                    classroomDropdown.querySelectorAll('.dropdown-option').forEach(option => {
                        option.classList.toggle('selected', option.getAttribute('data-value') === assignment.classroom_id);
                    });
                }
                
                // Reinitialize the classroom dropdown
                initializeDropdown('editAssignmentClassroomDropdown');
            }
            
            console.log('Showing modal...');
            
            // Show the modal
            const modal = document.getElementById('editAssignmentModal');
            console.log('Modal element:', modal);
            modal.classList.add('active');
            
            console.log('Modal should now be visible');
        }
        
        // Close edit assignment modal
        function closeEditAssignmentModal() {
            document.getElementById('editAssignmentModal').classList.remove('active');
        }
        
        // Update assignment (form submission for edit modal)
        async function updateAssignment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const assignmentId = formData.get('assignment_id');
            const vocabText = formData.get('vocab') || '';
            const vocabList = vocabText.split(',').map(v => v.trim()).filter(v => v.length > 0);
            
            try {
                const response = await fetch(`/api/assignments/${assignmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: formData.get('title'),
                        description: formData.get('description'),
                        instructions: formData.get('instructions'),
                        level: formData.get('level'),
                        duration: parseInt(formData.get('duration')),
                        due_date: formData.get('due_date') || null,
                        prompt: formData.get('prompt'),
                        vocab: vocabList,
                        min_vocab_words: parseInt(formData.get('min_vocab_words')) || 0
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Close modal
                    closeEditAssignmentModal();
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10001;
                        font-weight: 500;
                        font-size: 14px;
                    `;
                    successDiv.textContent = 'Assignment updated successfully!';
                    document.body.appendChild(successDiv);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);
                    
                    // Reload assignments from database
                    await loadAssignments();
                } else {
                    alert('Error updating assignment: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating assignment:', error);
                alert('Error updating assignment. Please try again.');
            }
        }
        
        // Delete assignment
        async function deleteAssignment(assignmentId) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                try {
                    const response = await fetch(`/api/assignments/${assignmentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Reload assignments from database
                        await loadAssignments();
                    } else {
                        const data = await response.json();
                        alert('Error deleting assignment: ' + data.detail);
                    }
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    alert('Error deleting assignment');
                }
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            console.log('Loading analytics...');
            
            // First load fresh data from server
            await loadData();
            
            console.log('Assignments:', assignments.length);
            console.log('Logs:', logs.length);
            
            // Update stats
            const uniqueStudents = new Set(logs.map(log => log.studentName)).size;
            const completedAssignments = logs.filter(log => log.completed).length;
            const totalVocabUsed = logs.reduce((sum, log) => sum + (log.usedVocabCount || 0), 0);
            const voiceUsageCount = logs.filter(log => log.voiceUsed).length;
            const avgCompletionRate = logs.length > 0 ? Math.round((completedAssignments / logs.length) * 100) : 0;
            const voiceUsageRate = logs.length > 0 ? Math.round((voiceUsageCount / logs.length) * 100) : 0;
            
            // Count only active assignments
            const activeAssignments = assignments.filter(assignment => {
                // Handle different possible values for is_active
                const isActive = assignment.is_active;
                
                // Consider it active if is_active is not explicitly false
                return isActive !== false && isActive !== 0 && isActive !== 'false';
            });
            console.log('Total assignments:', assignments.length, 'Active assignments:', activeAssignments.length);
            
            // Calculate vocabulary performance metrics
            const vocabRequirementsMet = logs.filter(log => {
                const minVocab = log.minVocabWords || 0;
                const usedVocab = log.usedVocabCount || 0;
                return minVocab > 0 && usedVocab >= minVocab;
            }).length;
            
            const totalVocabRequirements = logs.filter(log => (log.minVocabWords || 0) > 0).length;
            const vocabRequirementRate = totalVocabRequirements > 0 ? Math.round((vocabRequirementsMet / totalVocabRequirements) * 100) : 0;
            
            console.log('Calculated stats:', {
                uniqueStudents,
                completedAssignments,
                totalVocabUsed,
                voiceUsageCount,
                avgCompletionRate,
                voiceUsageRate
            });
            
            document.getElementById('totalAssignments').textContent = activeAssignments.length;
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('avgCompletion').textContent = avgCompletionRate + '%';
            document.getElementById('voiceUsage').textContent = voiceUsageRate + '%';
            
            // Load logs table
            const tableBody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">No student activity logs found. Students need to complete assignments for data to appear here.</td></tr>';
                return;
            }
            
            console.log('Building logs table...');
            
            // Debug: Check if submitted_for_grading field exists
            console.log('Sample log with submitted field:', logs[0]);
            console.log('Logs with submitted_for_grading:', logs.filter(l => l.submitted_for_grading).length);
            
            // Filter logs to show only submitted attempt (or most recent if none submitted) per student per assignment
            const filteredLogs = {};
            logs.forEach(log => {
                const key = `${log.studentId}-${log.assignmentId}`;
                console.log(`Processing log for ${log.studentName} - ${log.assignmentId}: submitted=${log.submitted_for_grading}, attempt=${log.attemptNumber}`);
                
                if (!filteredLogs[key]) {
                    filteredLogs[key] = log;
                } else {
                    const current = filteredLogs[key];
                    // Prefer submitted attempt
                    if (log.submitted_for_grading && !current.submitted_for_grading) {
                        console.log(`  Replacing with submitted attempt #${log.attemptNumber}`);
                        filteredLogs[key] = log;
                    }
                    // If both submitted or neither submitted, prefer newer
                    else if (log.submitted_for_grading === current.submitted_for_grading && 
                             new Date(log.createdAt) > new Date(current.createdAt)) {
                        console.log(`  Replacing with newer attempt #${log.attemptNumber}`);
                        filteredLogs[key] = log;
                    }
                }
            });
            
            console.log('Filtered logs count:', Object.keys(filteredLogs).length);
            
            // Store all logs for previous attempts feature
            window.allLogs = logs;
            
            // Use filtered logs for main table
            const displayLogs = Object.values(filteredLogs);
            
            // Store displayLogs globally for viewConversation function
            window.displayLogs = displayLogs;
            
            console.log('Display logs stored globally:', window.displayLogs.length);
            
            tableBody.innerHTML = displayLogs.map(log => {
                const assignment = assignments.find(a => a.id === log.assignmentId);
                const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
                const assignmentVocab = assignment ? assignment.vocab || [] : [];
                
                // Check if there are multiple attempts for this student/assignment
                const studentAttempts = window.allLogs.filter(l => 
                    l.assignmentId === log.assignmentId && 
                    l.studentName === log.studentName
                );
                const hasMultipleAttempts = studentAttempts.length > 1;
                
                // Debug: Log assignment matching
                if (!assignment) {
                    console.log('No assignment found for log:', log);
                }
                
                // Check vocabulary usage count and minimum requirement
                const vocabCount = log.usedVocabCount || 0;
                const minVocabWords = log.minVocabWords || 0;
                
                // Create vocabulary display with fraction and color coding
                let vocabDisplay;
                let vocabColor;
                
                if (minVocabWords > 0) {
                    // Show as fraction when there's a minimum requirement
                    vocabDisplay = `${vocabCount}/${minVocabWords}`;
                    // Color coding: red for below minimum, green for meeting or exceeding
                    vocabColor = vocabCount >= minVocabWords ? '#10b981' : '#ef4444';
                } else {
                    // Show just the count when no minimum requirement
                    vocabDisplay = vocabCount.toString();
                    vocabColor = '#666'; // Neutral gray color
                }
                
                // Get due date and check if submitted on time
                const dueDate = assignment ? assignment.due_date : null;
                const dueDateDisplay = dueDate ? new Date(dueDate).toLocaleDateString() : 'No due date';
                
                let onTimeDisplay = 'N/A';
                if (dueDate && log.completed && log.endTime) {
                    const submittedTime = new Date(log.endTime);
                    const dueTime = new Date(dueDate);
                    const isOnTime = submittedTime <= dueTime;
                    
                    if (isOnTime) {
                        onTimeDisplay = '<span style="color: #10b981; font-weight: 600;"> Yes</span>';
                    } else {
                        const daysLate = Math.ceil((submittedTime - dueTime) / (1000 * 60 * 60 * 24));
                        onTimeDisplay = `<span style="color: #ef4444; font-weight: 600;"> ${daysLate} day${daysLate !== 1 ? 's' : ''} late</span>`;
                    }
                } else if (dueDate && !log.completed) {
                    onTimeDisplay = '<span style="color: #f59e0b;"> Pending</span>';
                }
                
                return `
                    <tr>
                        <td><input type="checkbox" class="log-checkbox" value="${log.assignmentId}-${log.studentName}-${log.startTime}" style="width: 16px; height: 16px;" onchange="updateLogsToggleBtn()"></td>
                        <td>
                            <div>${log.studentName || 'Anonymous'}</div>
                            ${hasMultipleAttempts ? `<button class="btn btn-info btn-xs" onclick="viewStudentHistory('${log.assignmentId}', '${log.studentName}', '${log.studentId}')" style="font-size: 10px; padding: 2px 6px; margin-top: 4px; white-space: nowrap;">Previous Attempts</button>` : ''}
                        </td>
                        <td>${assignmentTitle}</td>
                        <td><span class="level-badge level-${log.level}">${log.level}</span></td>
                        <td>${assignment ? new Date(assignment.created_at).toLocaleDateString() : 'Unknown'}</td>
                        <td>${dueDateDisplay}</td>
                        <td>${onTimeDisplay}</td>
                        <td>${log.messageCount || 0}</td>
                        <td style="color: ${vocabColor}; font-weight: 500;">${vocabDisplay}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">Attempt #${log.attemptNumber || 1}</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="viewConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}')">
                                View Conversation
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('Analytics loading complete');
        }
        
        // View student history for all attempts
        async function viewStudentHistory(assignmentId, studentName, studentId) {
            try {
                // Use the stored all logs instead of fetching again
                const allLogs = window.allLogs || [];
                
                // Filter for this specific student and assignment
                const studentLogs = allLogs.filter(log => 
                    log.assignmentId === assignmentId && 
                    log.studentName === studentName
                ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Most recent first
                
                console.log('All logs for this student/assignment:', studentLogs.length);
                
                if (studentLogs.length <= 1) {
                    alert('No previous attempts found for this student and assignment.');
                    return;
                }
                
                // Find which attempt is displayed in main table (submitted or most recent)
                const displayedLog = window.displayLogs?.find(log => 
                    log.assignmentId === assignmentId && 
                    log.studentName === studentName
                );
                
                console.log('Displayed log:', displayedLog);
                
                // Remove the displayed attempt from previous attempts
                const previousAttempts = studentLogs.filter(log => log.id !== displayedLog?.id);
                
                console.log('Previous attempts (excluding displayed):', previousAttempts.length);
                
                if (previousAttempts.length === 0) {
                    alert('No previous attempts found for this student and assignment.');
                    return;
                }
                
                previousAttempts.forEach((log, index) => {
                    console.log(`History modal - Log ${index}:`, {
                        attemptNumber: log.attemptNumber,
                        startTime: log.startTime,
                        createdAt: log.createdAt
                    });
                });
                
                // Create history modal
                const modalHtml = `
                    <div id="historyModal" class="modal active">
                        <div class="modal-content" style="width: 800px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3>${studentName} - Previous Attempts (${previousAttempts.length})</h3>
                                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                ${previousAttempts.map((log, index) => {
                                    // Prepare date string outside template literal
                                    let dateString = 'Date not available';
                                    try {
                                        if (log.startTime) {
                                            const date = new Date(log.startTime);
                                            if (!isNaN(date.getTime())) {
                                                dateString = date.toLocaleString();
                                            }
                                        }
                                        if (dateString === 'Date not available' && log.endTime) {
                                            const endDate = new Date(log.endTime);
                                            if (!isNaN(endDate.getTime())) {
                                                dateString = endDate.toLocaleString();
                                            }
                                        }
                                        if (dateString === 'Date not available' && log.createdAt) {
                                            const createdDate = new Date(log.createdAt);
                                            if (!isNaN(createdDate.getTime())) {
                                                dateString = createdDate.toLocaleString();
                                            }
                                        }
                                    } catch (e) {
                                        dateString = 'Date error';
                                    }
                                    return `
                                    <div style="margin-bottom: 20px; padding: 24px; border: 1px solid #e2e8f0; border-radius: 12px; background: ${index === 0 ? 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)' : '#ffffff'}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.2s ease;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">
                                                    #${log.attemptNumber || 1}
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #1e40af; font-size: 18px; font-weight: 600;">
                                                        Attempt ${log.attemptNumber || 1}
                                                    </h4>
                                                    <span style="color: #64748b; font-size: 13px; font-weight: 500;">
                                                        ${log.completed ? ' Completed' : ' Incomplete'}  ${dateString}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border-left: 3px solid #6366f1;">
                                                <span style="font-size: 11px; color: #6366f1; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Messages</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.messageCount || 0}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border-left: 3px solid ${log.usedVocabCount >= (log.minVocabWords || 0) ? '#10b981' : '#ef4444'};">
                                                <span style="font-size: 11px; color: ${log.usedVocabCount >= (log.minVocabWords || 0) ? '#10b981' : '#ef4444'}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Vocabulary</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.usedVocabCount || 0}/${log.minVocabWords || 0}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                                <span style="font-size: 11px; color: #f59e0b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Duration</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.startTime && log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) + ' min' : 'N/A'}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                                                <span style="font-size: 11px; color: #8b5cf6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Voice</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.voiceUsed ? 'Yes' : 'No'}</span>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" onclick="viewHistoryConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}', '${log.attemptNumber || 1}')">
                                            View Conversation
                                        </button>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading student history:', error);
                alert('Error loading student history. Please try again.');
            }
        }
        
        // Close history modal
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // View conversation from history modal (closes history modal first)
        async function viewHistoryConversation(assignmentId, studentName, startTime, attemptNumber) {
            console.log('Viewing history conversation:', { assignmentId, studentName, startTime, attemptNumber });
            
            // Close history modal first
            closeHistoryModal();
            
            // Wait a moment for modal to close, then open conversation
            setTimeout(async () => {
                // First find the session ID, then get conversation directly
                try {
                    console.log('Fetching ALL logs to find session ID...');
                    const logsResponse = await fetch('/api/logs/all');
                    const logsData = await logsResponse.json();
                    const allLogs = logsData.logs || [];
                    
                    const log = allLogs.find(l => 
                        l.assignmentId === assignmentId && 
                        l.studentName === studentName && 
                        l.startTime === startTime
                    );
                    
                    console.log('Found log:', log);
                    
                    if (!log) {
                        console.error('Log not found. Available logs:', allLogs.slice(0, 3).map(l => ({ 
                        assignmentId: l.assignmentId, 
                        studentName: l.studentName, 
                        startTime: l.startTime 
                    })));
                        alert('Student log not found');
                        return;
                    }
                    
                    // Get session ID from the log
                    const sessionId = log.id;
                    console.log('Session ID:', sessionId);
                    
                    // Fetch conversation directly for this session
                    console.log('Fetching conversation for session:', sessionId);
                    const conversationResponse = await fetch(`/api/sessions/${sessionId}/conversation`);
                    console.log('Conversation response status:', conversationResponse.status);
                    
                    const conversationData = await conversationResponse.json();
                    console.log('Conversation data received:', conversationData);
                    
                    if (conversationData.error) {
                        console.error('Conversation error:', conversationData.error);
                        alert('Error loading conversation: ' + conversationData.error);
                        return;
                    }
                    
                    const conversation = conversationData.conversation || [];
                    console.log('Conversation loaded:', conversation.length, 'messages');
                    
                    if (conversation.length === 0) {
                        console.log('No conversation messages found');
                        alert('Conversation transcript not available - no conversation data was recorded');
                        return;
                    }
                    
                    console.log('First message:', conversation[0]);
                    console.log('Last message:', conversation[conversation.length - 1]);
                    
                    console.log('Loading conversation modal...');
                    
                    const assignment = assignments.find(a => a.id === assignmentId);
                    const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
                    const assignmentVocab = assignment ? assignment.vocab || [] : [];
                    
                    // Update modal header with session info including attempt number
                    document.getElementById('conversationTitle').textContent = `${studentName} - ${assignmentTitle} (Attempt #${attemptNumber})`;
                    
                    // Update session stats
                    const sessionDuration = log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) : 0;
                    document.getElementById('conversationStats').innerHTML = `
                        <span>${log.messageCount} messages</span>
                        <span>${log.voiceUsed ? 'Voice used' : 'Text only'}</span>
                        <span>${sessionDuration} minutes</span>
                        <span class="level-badge level-${log.level}">${log.level}</span>
                    `;
                    
                    // Update conversation meta (session info like main modal)
                    const sessionDate = log.start_time || log.startTime || log.endTime || log.createdAt;
                    document.getElementById('conversationMeta').innerHTML = `
                        Session: ${sessionDate ? new Date(sessionDate).toLocaleString() : 'Date not available'} ${log.completed ? '- Completed' : '- In Progress'}
                    `;
                    
                    // Hide vocabulary section completely
                    document.getElementById('conversationVocab').innerHTML = '';
                    
                    // Function to highlight vocabulary words in text
                    function highlightVocabulary(text, vocabList) {
                        let highlightedText = text;
                        vocabList.forEach(word => {
                            const regex = new RegExp(`\\b${word}\\b`, 'gi');
                            highlightedText = highlightedText.replace(regex, `<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px; font-weight: 600;">${word}</mark>`);
                        });
                        return highlightedText;
                    }
                    
                    // Display conversation with highlighted vocabulary
                    const conversationContainer = document.getElementById('conversationContent');
                    conversationContainer.innerHTML = `
                        <h5 style="margin: 20px 0 15px 0; color: #333;">Conversation Transcript</h5>
                        ${conversation.map(msg => {
                            const senderClass = msg.message_type === 'user' ? 'user-message' : 'bot-message';
                            const senderLabel = msg.message_type === 'user' ? studentName : 'AI Tutor';
                            const timestamp = new Date(msg.timestamp || msg.created_at).toLocaleTimeString();
                            
                            // Only highlight vocabulary in student messages
                            const highlightedContent = msg.message_type === 'user' ? 
                                highlightVocabulary(msg.content, assignmentVocab) : 
                                msg.content;
                            
                            return `
                                <div class="message ${senderClass}" style="margin-bottom: 15px; padding: 12px; border-radius: 8px; background: ${msg.message_type === 'user' ? '#e3f2fd' : '#f3e5f5'};">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">${senderLabel} - ${timestamp}</div>
                                    <div style="line-height: 1.5;">${highlightedContent}</div>
                                </div>
                            `;
                        }).join('')}
                    `;
                    
                    // Show modal with same dimensions as main conversation
                    const conversationModal = document.getElementById('conversationModal');
                    console.log('Conversation modal element found:', conversationModal);
                    
                    const modalContent = conversationModal.querySelector('.modal-content');
                    console.log('Modal content element found:', modalContent);
                    
                    if (modalContent) {
                        // Debug: Log current styles
                        console.log('Current modal content styles:', {
                            width: modalContent.style.width,
                            maxWidth: modalContent.style.maxWidth,
                            computedWidth: window.getComputedStyle(modalContent).width,
                            computedMaxWidth: window.getComputedStyle(modalContent).maxWidth
                        });
                        
                        // Match student dashboard modal dimensions exactly
                        modalContent.style.width = '';
                        modalContent.style.maxWidth = '90%';
                        modalContent.style.maxHeight = '90vh';
                        modalContent.style.overflowY = 'auto';
                    } else {
                        console.error('Modal content not found!');
                    }
                    
                    conversationModal.classList.add('active');
                    console.log('Conversation modal should now be visible with forced dimensions');
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    alert('Error loading conversation. Please try again. Error: ' + error.message);
                }
            }, 300);
        }
        
        // Update logs toggle button text based on checkbox states
        function updateLogsToggleBtn() {
            const button = document.getElementById('logsToggleBtn');
            const checkboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            if (allChecked && checkboxes.length > 0) {
                button.textContent = 'Deselect All';
                selectAllCheckbox.checked = true;
            } else {
                button.textContent = 'Select All';
                selectAllCheckbox.checked = false;
            }
        }
        
        // Initialize
        loadData();
        loadActiveTab(); // Load saved tab state
        
        // View conversation function
        async function viewConversation(assignmentId, studentName, startTime) {
            console.log('Viewing conversation:', { assignmentId, studentName, startTime });
            
            // First try to find in the filtered display logs (submitted attempts)
            let log = window.displayLogs?.find(l => 
                l.assignmentId === assignmentId && 
                l.studentName === studentName && 
                l.startTime === startTime
            );
            
            // If not found in display logs, try the original logs array
            if (!log) {
                log = logs.find(l => 
                    l.assignmentId === assignmentId && 
                    l.studentName === studentName && 
                    l.startTime === startTime
                );
            }
            
            // If still not found, fetch all logs to find the specific session
            if (!log) {
                try {
                    const response = await fetch('/api/logs');
                    const data = await response.json();
                    const allLogs = data.logs || [];
                    log = allLogs.find(l => 
                        l.assignmentId === assignmentId && 
                        l.studentName === studentName && 
                        l.startTime === startTime
                    );
                } catch (error) {
                    console.error('Error fetching all logs:', error);
                }
            }
            
            console.log('Found log:', log);
            
            if (!log) {
                alert('Student log not found');
                return;
            }
            
            if (!log.conversation || log.conversation.length === 0) {
                alert('Conversation transcript not available - no conversation data was recorded');
                return;
            }
            
            const assignment = assignments.find(a => a.id === assignmentId);
            const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
            const assignmentVocab = assignment ? assignment.vocab || [] : [];
            const usedVocab = log.usedVocab || [];
            
            // Update modal header with session info including attempt number
            document.getElementById('conversationTitle').textContent = `${studentName} - ${assignmentTitle} (Attempt #${log.attemptNumber || 1})`;
            
            // Update session stats
            const sessionDuration = log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) : 0;
            document.getElementById('conversationStats').innerHTML = `
                <span>${log.messageCount} messages</span>
                <span>${log.voiceUsed ? 'Voice used' : 'Text only'}</span>
                <span>${sessionDuration} minutes</span>
                <span class="level-badge level-${log.level}">${log.level}</span>
            `;
            
            // Update meta info
            const sessionDate = log.startTime || log.start_time || log.endTime || log.createdAt;
            document.getElementById('conversationMeta').innerHTML = `
                Session: ${sessionDate ? new Date(sessionDate).toLocaleString() : 'Date not available'} ${log.completed ? '- Completed' : '- In Progress'}
            `;
            
            // Hide vocabulary section completely
            document.getElementById('conversationVocab').innerHTML = '';
            
            // Function to highlight vocabulary words in text
            function highlightVocabulary(text, vocabList) {
                let highlightedText = text;
                vocabList.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    highlightedText = highlightedText.replace(regex, `<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px; font-weight: 600;">${word}</mark>`);
                });
                return highlightedText;
            }
            
            // Display conversation with highlighted vocabulary (but no vocabulary section)
            const conversationContent = document.getElementById('conversationContent');
            conversationContent.innerHTML = `
                <h5 style="margin: 20px 0 15px 0; color: #333;">Conversation Transcript</h5>
                ${log.conversation.map(msg => {
                    const senderClass = msg.message_type === 'user' ? 'user-message' : 'bot-message';
                    const senderLabel = msg.message_type === 'user' ? studentName : 'AI Tutor';
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString();
                    
                    // Only highlight vocabulary in student messages
                    const highlightedContent = msg.message_type === 'user' ? 
                        highlightVocabulary(msg.content, assignmentVocab) : 
                        msg.content;
                    
                    return `
                        <div class="message ${senderClass}" style="margin-bottom: 15px; padding: 12px; border-radius: 8px; background: ${msg.message_type === 'user' ? '#e3f2fd' : '#f3e5f5'};">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">${senderLabel} - ${timestamp}</div>
                            <div style="line-height: 1.5;">${highlightedContent}</div>
                        </div>
                    `;
                }).join('')}
            `;
            
            // Show modal
            const conversationModal = document.getElementById('conversationModal');
            const modalContent = conversationModal.querySelector('.modal-content');
            
            // Match student dashboard modal dimensions exactly
            if (modalContent) {
                modalContent.style.width = '';
                modalContent.style.maxWidth = '90%';
                modalContent.style.maxHeight = '90vh';
                modalContent.style.overflowY = 'auto';
            }
            
            conversationModal.classList.add('active');
        }
        
        function closeConversationModal() {
            document.getElementById('conversationModal').classList.remove('active');
        }
        
        // Bulk selection functions
        function toggleAssignmentsSelection() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            if (allChecked) {
                // Deselect all
                checkboxes.forEach(checkbox => checkbox.checked = false);
                button.textContent = 'Select All';
            } else {
                // Select all
                checkboxes.forEach(checkbox => checkbox.checked = true);
                button.textContent = 'Deselect All';
            }
        }
        
        function selectAllAssignments() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            button.textContent = 'Deselect All';
        }
        
        function deselectAllAssignments() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            button.textContent = 'Select All';
        }
        
        function getSelectedAssignments() {
            const checkboxes = document.querySelectorAll('.assignment-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function deleteSelectedAssignments() {
            const selectedIds = getSelectedAssignments();
            
            if (selectedIds.length === 0) {
                alert('Please select at least one assignment to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} assignment(s)? This action cannot be undone.`)) {
                // Remove assignments from array
                assignments = assignments.filter(a => !selectedIds.includes(a.id));
                
                // Also remove associated logs
                logs = logs.filter(log => !selectedIds.includes(log.assignmentId));
                
                // Save data
                saveData();
                
                // Refresh the assignments list
                loadAssignments();
                
                // Update analytics if on that tab
                if (document.querySelector('.nav-tab.active').textContent.includes('Analytics')) {
                    loadAnalytics();
                }
                
                alert(`Successfully deleted ${selectedIds.length} assignment(s).`);
            }
        }
        
        // Log management functions
        function toggleLogsSelection() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const allChecked = Array.from(logCheckboxes).every(cb => cb.checked);
            
            if (allChecked) {
                // Deselect all
                logCheckboxes.forEach(checkbox => checkbox.checked = false);
                selectAllCheckbox.checked = false;
                button.textContent = 'Select All';
            } else {
                // Select all
                logCheckboxes.forEach(checkbox => checkbox.checked = true);
                selectAllCheckbox.checked = true;
                button.textContent = 'Deselect All';
            }
        }
        
        function toggleAllLogs() {
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
            
            // Update button text
            if (selectAllCheckbox.checked) {
                button.textContent = 'Deselect All';
            } else {
                button.textContent = 'Select All';
            }
        }
        
        function selectAllLogs() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = true);
            selectAllCheckbox.checked = true;
            button.textContent = 'Deselect All';
        }
        
        function deselectAllLogs() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = false);
            selectAllCheckbox.checked = false;
            button.textContent = 'Select All';
        }
        
        function getSelectedLogs() {
            const checkboxes = document.querySelectorAll('.log-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function deleteSelectedLogs() {
            const selectedLogs = getSelectedLogs();
            
            if (selectedLogs.length === 0) {
                alert('Please select at least one log to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedLogs.length} student log(s)? This action cannot be undone.`)) {
                // Get the logs that will be deleted to update assignment stats
                const logsToDelete = logs.filter(log => {
                    const logKey = `${log.assignmentId}-${log.studentName}-${log.startTime}`;
                    return selectedLogs.includes(logKey);
                });
                
                // Remove logs from array
                logs = logs.filter(log => {
                    const logKey = `${log.assignmentId}-${log.studentName}-${log.startTime}`;
                    return !selectedLogs.includes(logKey);
                });
                
                // Update assignment statistics for each deleted log
                logsToDelete.forEach(deletedLog => {
                    const assignment = assignments.find(a => a.id === deletedLog.assignmentId);
                    if (assignment) {
                        // Decrement completion count if the log was completed
                        if (deletedLog.completed) {
                            assignment.completionCount = Math.max(0, (assignment.completionCount || 0) - 1);
                        }
                        
                        // Check if this was the only log for this student
                        const remainingLogsForStudent = logs.filter(log => 
                            log.assignmentId === deletedLog.assignmentId && 
                            log.studentName === deletedLog.studentName
                        );
                        
                        // If no more logs for this student, decrement student count
                        if (remainingLogsForStudent.length === 0) {
                            assignment.studentCount = Math.max(0, (assignment.studentCount || 0) - 1);
                        }
                    }
                });
                
                // Save data
                saveData();
                
                // Refresh the analytics display
                loadAnalytics();
                
                alert(`Successfully deleted ${selectedLogs.length} student log(s).`);
            }
        }
    </script>
    
    <!-- Edit Assignment Modal -->
    <div id="editAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Assignment</h2>
                <span class="modal-close" onclick="closeEditAssignmentModal()">&times;</span>
            </div>
            <form class="assignment-form" onsubmit="updateAssignment(event)">
                <input type="hidden" id="editAssignmentId" name="assignment_id">
                
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-group">
                        <label for="editAssignmentTitle">Assignment Title</label>
                        <input type="text" id="editAssignmentTitle" name="title" required placeholder="e.g., Ordering Food at a Restaurant">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAssignmentClassroom">Classroom</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-trigger" onclick="toggleDropdown('editAssignmentClassroomDropdown')">
                                    <span id="editAssignmentClassroomDisplay">Select Classroom</span>
                                    <div class="dropdown-arrow"></div>
                                </div>
                                <div class="dropdown-options" id="editAssignmentClassroomDropdown" style="display: none;">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                            <select id="editAssignmentClassroom" name="classroom_id" disabled style="display: none;">
                                <option value="">Select Classroom</option>
                            </select>
                            <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Classroom cannot be changed when editing</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editAssignmentLevel">Difficulty Level</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-trigger" onclick="toggleDropdown('editAssignmentLevelDropdown')">
                                    <span id="editAssignmentLevelDisplay">Select Level</span>
                                    <div class="dropdown-arrow"></div>
                                </div>
                                <div class="dropdown-options" id="editAssignmentLevelDropdown" style="display: none;">
                                    <div class="dropdown-option" data-value="">Select Level</div>
                                    <div class="dropdown-option" data-value="beginner">Beginner</div>
                                    <div class="dropdown-option" data-value="intermediate">Intermediate</div>
                                    <div class="dropdown-option" data-value="advanced">Advanced</div>
                                </div>
                            </div>
                            <select id="editAssignmentLevel" name="level" required style="display: none;">
                                <option value="">Select Level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAssignmentDuration">Duration (minutes)</label>
                            <input type="number" id="editAssignmentDuration" name="duration" min="1" max="60" step="1" value="5" required>
                        </div>
                        <div class="form-group">
                            <label for="editAssignmentDueDate">Due Date (Optional)</label>
                            <input type="datetime-local" id="editAssignmentDueDate" name="due_date">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Content Details</div>
                    <div class="form-group">
                        <label for="editAssignmentDescription">Assignment Description</label>
                        <textarea id="editAssignmentDescription" name="description" required placeholder="Describe what students should practice and accomplish in this assignment..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAssignmentInstructions">Student Instructions</label>
                        <textarea id="editAssignmentInstructions" name="instructions" required placeholder="Clear instructions for students on how to complete this assignment..."></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Advanced Options</div>
                    <div class="form-group">
                        <label for="editAssignmentPrompt">Custom Prompt (Optional)</label>
                        <textarea id="editAssignmentPrompt" name="prompt" placeholder="Override the default system prompt with custom instructions for the AI..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAssignmentVocab">Key Vocabulary (Optional)</label>
                        <textarea id="editAssignmentVocab" name="vocab" placeholder="Enter important vocabulary words or phrases (comma-separated). These will be tracked in student logs..."></textarea>
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Example: zapatos, talla, color, precio, comprar, tienda</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="editMinVocabWords">Minimum Vocabulary Words Required</label>
                        <input type="number" id="editMinVocabWords" name="min_vocab_words" min="0" max="20" step="1" value="0" placeholder="Number of vocabulary words students must use">
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Set to 0 for no minimum requirement. Students will be tracked on how many unique vocabulary words they use.</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-self: center;">Save Assignment</button>
            </form>
        </div>
    </div>
</body>
</html>
