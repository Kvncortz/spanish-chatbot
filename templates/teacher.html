<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocaFlow - Teacher Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 25px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.025em;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.025em;
            position: relative;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.08);
            color: #667eea;
            transform: translateY(-1px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .assignment-form {
            display: grid;
            gap: 24px;
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            letter-spacing: -0.025em;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: #f8fafc;
            color: #2d3748;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #a0aec0;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.5;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .form-section {
            padding: 24px;
            background: #f8fafc;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.025em;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f8fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: white;
            border-color: #cbd5e0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .assignments-list {
            display: grid;
            gap: 20px;
        }
        
        .assignment-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        .assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 1 !important;
            display: block !important;
            width: 18px !important;
            height: 18px !important;
            cursor: pointer !important;
        }
        
        .assignment-card:hover .assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Force checkbox visibility - ALWAYS VISIBLE */
        input[type="checkbox"].assignment-checkbox {
            -webkit-appearance: checkbox !important;
            -moz-appearance: checkbox !important;
            appearance: checkbox !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 999 !important;
            display: inline-block !important;
            width: 18px !important;
            height: 18px !important;
            cursor: pointer !important;
            background: white !important;
            border: 2px solid #d1d5db !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Make sure checkboxes are visible in ALL states */
        input[type="checkbox"].assignment-checkbox:before,
        input[type="checkbox"].assignment-checkbox:after,
        input[type="checkbox"].assignment-checkbox:hover,
        input[type="checkbox"].assignment-checkbox:focus,
        input[type="checkbox"].assignment-checkbox:active {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Override any parent hover effects */
        * input[type="checkbox"].assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        
        /* Force visibility on any parent element hover */
        .assignment-card * input[type="checkbox"].assignment-checkbox,
        .assignment-header * input[type="checkbox"].assignment-checkbox,
        .assignment-card:hover * input[type="checkbox"].assignment-checkbox,
        .assignment-header:hover * input[type="checkbox"].assignment-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        
        input[type="checkbox"].assignment-checkbox:checked {
            background-color: #667eea !important;
            border-color: #667eea !important;
        }
        
        input[type="checkbox"].assignment-checkbox:hover {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3) !important;
        }
        
        input[type="checkbox"].assignment-checkbox:focus {
            outline: 2px solid #667eea !important;
            outline-offset: 2px !important;
        }
        
        .assignment-card h3 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        
        .assignment-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .assignment-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .assignment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 10px;
        }
        
        .btn-xs {
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 35px;
            margin-bottom: 50px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .logs-table {
            width: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
        }
        
        .logs-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .logs-table th {
            background: #f8f9fa;
            padding: 20px 18px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .logs-table td {
            padding: 18px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }
        
        .logs-table tr:hover {
            background: #f8f9fa;
        }
        
        .level-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .level-beginner {
            background: #d4edda;
            color: #155724;
        }
        
        .level-intermediate {
            background: #fff3cd;
            color: #856404;
        }
        
        .level-advanced {
            background: #f8d7da;
            color: #721c24;
        }
        
        .voice-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .voice-used {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .voice-not-used {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .transcript-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .transcript-used {
            background: #d4edda;
            color: #155724;
        }
        
        .transcript-not-used {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f1f5f9;
            color: #333;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background: #f3e5f5;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-content {
            line-height: 1.5;
            margin-bottom: 5px;
        }
        
        .message-time {
            font-size: 11px;
            color: #666;
        }
        
        .message.user .message-time {
            text-align: right;
        }
        
        .message.assistant .message-time {
            text-align: left;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-header h2 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .modal-header p {
            color: #666;
            font-size: 14px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .share-link {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
            margin-bottom: 10px;
        }
        
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .copy-btn:hover {
            background: #5a6fd8;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .assignment-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .assignment-actions {
                justify-content: stretch;
            }
            
            .btn-small {
                flex: 1;
            }
        }
        
        .home-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .home-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: inherit;
        }
        
        .home-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .home-btn-absolute {
            position: absolute;
            top: 24px;
            left: 24px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .home-btn-absolute:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .logout-btn-absolute {
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        .logout-btn-absolute:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .classrooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }
        
        .classroom-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-align: center;
        }
        
        .classroom-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        .classroom-card .classroom-checkbox {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 10 !important;
            background: white !important;
            border: 2px solid #667eea !important;
            border-radius: 4px !important;
            transition: all 0.2s ease;
        }
        
        .classroom-card:hover .classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            border-color: #667eea !important;
        }
        
        /* Force classroom checkbox visibility */
        input[type="checkbox"].classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            position: absolute !important;
            z-index: 999 !important;
            display: block !important;
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            background: white !important;
            border: 2px solid #667eea !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Override any hover effects that might hide classroom checkboxes */
        .classroom-card:hover input[type="checkbox"].classroom-checkbox,
        .classroom-header:hover input[type="checkbox"].classroom-checkbox,
        * input[type="checkbox"].classroom-checkbox {
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        input[type="checkbox"].classroom-checkbox:checked {
            background-color: #667eea !important;
            border-color: #667eea !important;
        }
        
        input[type="checkbox"].classroom-checkbox:hover {
            border-color: #764ba2 !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3) !important;
        }
        
        .classroom-header {
            margin-bottom: 16px;
        }
        
        .classroom-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .classroom-meta {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 16px;
        }
        
        .classroom-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .classroom-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .classroom-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .join-code {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* Fix spacing for classroom creation modal */
        .modal-form {
            display: grid;
            gap: 24px;
        }
        
        .modal-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 0;
        }
        
        .modal-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .modal-form .modal-actions {
            margin-top: 30px;
        }
        
        /* Custom Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            color: white;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            color: white;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            color: white;
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .notification.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            color: white;
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
            opacity: 0.95;
        }
        
        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s ease;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .notification-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 400px;
            transform: translateX(500px);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .notification-modal.show {
            transform: translateX(0);
        }
        
        .notification-modal.success {
            border-left-color: #10b981;
        }
        
        .notification-modal.error {
            border-left-color: #ef4444;
        }
        
        .notification-modal.warning {
            border-left-color: #f59e0b;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .notification-message {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: #f3f4f6;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: center; flex: 1;">
                    <h1>VocaFlow</h1>
                    <p>Create assignments, track student progress, and monitor engagement</p>
                </div>
            </div>
        </div>
        
        <button class="logout-btn-absolute" onclick="logout()">Logout</button>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('classrooms')">Classroom Management</button>
            <button class="nav-tab" onclick="switchTab('create')">Create Assignment</button>
            <button class="nav-tab" onclick="switchTab('assignments')">My Assignments</button>
            <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
            <button class="nav-tab" onclick="switchTab('profile')">Teacher Profile</button>
        </div>
        
        <!-- Classroom Management Tab -->
        <div id="classrooms-tab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">My Classrooms</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="classroomsToggleBtn" onclick="toggleClassroomsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" id="deleteSelectedClassroomsBtn" onclick="deleteSelectedClassrooms()" style="background: #dc3545; color: white;">Delete Selected</button>
                    <button class="btn btn-primary" onclick="showCreateClassroomModal()">Create New Classroom</button>
                </div>
            </div>
            <div class="classrooms-grid" id="classroomsGrid">
                <!-- Classrooms will be loaded here -->
            </div>
        </div>
        
        <!-- Teacher Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div style="max-width: 600px; margin: 0 auto;">
                <h3 style="margin-bottom: 30px; color: #333;">Teacher Profile</h3>
                
                <form class="assignment-form" onsubmit="updateTeacherProfile(event)">
                    <div class="form-group">
                        <label for="teacherName">Full Name</label>
                        <input type="text" id="teacherName" name="name" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherEmail">Email Address</label>
                        <input type="email" id="teacherEmail" name="email" required placeholder="your.email@school.edu">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherSchool">School Name</label>
                        <input type="text" id="teacherSchool" name="school" placeholder="Enter your school name">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherTitle">Title/Position</label>
                        <input type="text" id="teacherTitle" name="title" placeholder="e.g., Spanish Teacher, Department Head">
                    </div>
                    
                    <div class="form-group">
                        <label for="teacherBio">Bio (Optional)</label>
                        <textarea id="teacherBio" name="bio" placeholder="Tell your students about yourself..." style="min-height: 100px;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>
        </div>
        
        <!-- Create Assignment Tab -->
        <div id="create-tab" class="tab-content">
            <form class="assignment-form" onsubmit="createAssignment(event)">
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-group">
                        <label for="assignmentTitle">Assignment Title</label>
                        <input type="text" id="assignmentTitle" name="title" required placeholder="e.g., Ordering Food at a Restaurant">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assignmentClassroom">Classroom</label>
                            <select id="assignmentClassroom" name="classroom_id" required>
                                <option value="">Select Classroom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="assignmentLevel">Difficulty Level</label>
                            <select id="assignmentLevel" name="level" required>
                                <option value="">Select Level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assignmentDuration">Duration (minutes)</label>
                            <input type="number" id="assignmentDuration" name="duration" min="1" max="60" step="1" value="5" required>
                        </div>
                        <div class="form-group">
                            <label for="assignmentDueDate">Due Date (Optional)</label>
                            <input type="datetime-local" id="assignmentDueDate" name="due_date">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Content Details</div>
                    <div class="form-group">
                        <label for="assignmentDescription">Assignment Description</label>
                        <textarea id="assignmentDescription" name="description" required placeholder="Describe what students should practice and accomplish in this assignment..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignmentInstructions">Student Instructions</label>
                        <textarea id="assignmentInstructions" name="instructions" required placeholder="Clear instructions for students on how to complete this assignment..."></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Advanced Options</div>
                    <div class="form-group">
                        <label for="assignmentPrompt">Custom Prompt (Optional)</label>
                        <textarea id="assignmentPrompt" name="prompt" placeholder="Override the default system prompt with custom instructions for the AI..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignmentVocab">Key Vocabulary (Optional)</label>
                        <textarea id="assignmentVocab" name="vocab" placeholder="Enter important vocabulary words or phrases (comma-separated). These will be tracked in student logs..."></textarea>
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Example: zapatos, talla, color, precio, comprar, tienda</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="minVocabWords">Minimum Vocabulary Words Required</label>
                        <input type="number" id="minVocabWords" name="min_vocab_words" min="0" max="20" step="1" value="0" placeholder="Number of vocabulary words students must use">
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Set to 0 for no minimum requirement. Students will be tracked on how many unique vocabulary words they use.</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-self: center;">Create Assignment</button>
            </form>
        </div>
        
        <!-- My Assignments Tab -->
        <div id="assignments-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">My Assignments</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="assignmentsToggleBtn" onclick="toggleAssignmentsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteSelectedAssignments()" style="background: #dc3545; color: white;">Delete Selected</button>
                </div>
            </div>
            <div class="assignments-list" id="assignmentsList">
                <!-- Assignments will be loaded here -->
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">Student Activity Logs</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="logsToggleBtn" onclick="toggleLogsSelection()">Select All</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteSelectedLogs()" style="background: #dc3545; color: white;">Delete Selected</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAssignments">0</div>
                    <div class="stat-label">Total Assignments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Students Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgCompletion">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="voiceUsage">0%</div>
                    <div class="stat-label">Student Speaking Rate</div>
                </div>
            </div>
            
            <div class="logs-table">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllLogsCheckbox" onchange="toggleAllLogs()" style="width: 16px; height: 16px;"></th>
                            <th>Student</th>
                            <th>Assignment</th>
                            <th>Level</th>
                            <th>Date Assigned</th>
                            <th>Due Date</th>
                            <th>Submitted On Time</th>
                            <th>Messages</th>
                            <th>Vocabulary Used</th>
                            <th>Attempt Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Share Assignment Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Assignment</h2>
                <p>Share this link with your students</p>
            </div>
            <div class="share-link" id="shareLink"></div>
            <button class="copy-btn" onclick="copyShareLink()">ðŸ“‹ Copy Link</button>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Conversation Modal -->
    <div id="conversationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Conversation Transcript</h3>
                <button class="modal-close" onclick="closeConversationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="conversationHeader" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4 id="conversationTitle" style="margin: 0 0 5px 0; color: #333;">Loading...</h4>
                    <div id="conversationStats" style="display: flex; gap: 15px; margin-top: 8px; font-size: 14px; color: #666;">
                        <!-- Stats will be populated here -->
                    </div>
                    <div id="conversationMeta" style="margin-top: 8px; font-size: 12px; color: #64748b;">
                        <!-- Meta info will be populated here -->
                    </div>
                </div>
                <div id="conversationVocab" style="margin-top: 20px;">
                    <!-- Vocabulary usage will be displayed here -->
                </div>
                <div id="conversationContent">
                    <!-- Conversation will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Classroom Details Modal -->
    <div id="classroomDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Classroom Details</h2>
                <p id="classroomDetailsInfo">Loading classroom information...</p>
            </div>
            <div id="classroomDetailsContent" style="max-height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
                <!-- Classroom details will be loaded here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeClassroomDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Create Classroom Modal -->
    <div id="createClassroomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Classroom</h2>
                <p>Set up a new classroom for your students</p>
            </div>
            <form class="modal-form" onsubmit="createClassroom(event)">
                <div class="form-group">
                    <label for="modalClassroomName">Classroom Name</label>
                    <input type="text" id="modalClassroomName" name="name" required placeholder="e.g., Spanish 101 - Fall 2024">
                </div>
                
                <div class="form-group">
                    <label for="modalClassroomDescription">Description</label>
                    <textarea id="modalClassroomDescription" name="description" placeholder="Describe your classroom and learning objectives..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="modalGradeLevel">Spanish Course Level</label>
                    <select id="modalGradeLevel" name="gradeLevel">
                        <option value="">Select Spanish Level</option>
                        <option value="Spanish 1">Spanish 1</option>
                        <option value="Spanish 2">Spanish 2</option>
                        <option value="Spanish 3">Spanish 3</option>
                        <option value="Spanish 4">Spanish 4</option>
                        <option value="Spanish 5">Spanish 5</option>
                        <option value="AP Spanish">AP Spanish</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="modalAdvanced" name="advanced" style="width: auto; margin: 0;">
                        <span>Honors Level</span>
                    </label>
                    <small style="color: #718096; font-size: 13px; margin-top: 4px; display: block;">Check if this is an honors level course</small>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateClassroomModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Classroom</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Notification Modal -->
    <div id="notificationModal" class="notification-modal">
        <button class="notification-close" onclick="hideNotification()">Ã—</button>
        <div class="notification-title" id="notificationTitle">Success</div>
        <div class="notification-message" id="notificationMessage">Operation completed successfully</div>
    </div>
    
    <script>
        let assignments = [];
        let logs = [];
        let currentTeacher = null;
        let classrooms = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadOrCreateTeacher();
            loadActiveTab();
        });
        
        // Custom notification system
        function showNotification(title, message, type = 'success') {
            const modal = document.getElementById('notificationModal');
            const titleElement = document.getElementById('notificationTitle');
            const messageElement = document.getElementById('notificationMessage');
            
            // Set content
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Set type
            modal.className = 'notification-modal ' + type;
            
            // Show notification
            setTimeout(() => {
                modal.classList.add('show');
            }, 100);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        function hideNotification() {
            const modal = document.getElementById('notificationModal');
            modal.classList.remove('show');
        }
        
        // Replace alert calls with custom notifications
        function showAlert(message, type = 'success') {
            showNotification(type === 'error' ? 'Error' : 'Success', message, type);
        }
        
        // Teacher management
        async function loadOrCreateTeacher() {
            const savedTeacher = sessionStorage.getItem('currentTeacher');
            if (savedTeacher) {
                currentTeacher = JSON.parse(savedTeacher);
            } else {
                // Redirect to login page
                window.location.href = '/teacher-login';
                return;
            }
            
            if (currentTeacher) {
                loadClassrooms();
                loadClassroomSelect();
            }
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('currentTeacher');
            window.location.href = '/';
        }
        
        // Load data from server
        async function loadData() {
            try {
                // Load assignments from server
                const assignmentsResponse = await fetch('/api/assignments');
                const assignmentsData = await assignmentsResponse.json();
                assignments = assignmentsData.assignments || [];
                
                // Load logs from server
                const logsResponse = await fetch('/api/logs');
                const logsData = await logsResponse.json();
                logs = logsData.logs || [];
                
                console.log('Loaded from server:', { assignments: assignments.length, logs: logs.length });
            } catch (error) {
                console.error('Error loading data from server:', error);
                // Fallback to localStorage
                const savedAssignments = localStorage.getItem('assignments');
                const savedLogs = localStorage.getItem('logs');
                
                if (savedAssignments) {
                    assignments = JSON.parse(savedAssignments);
                }
                
                if (savedLogs) {
                    logs = JSON.parse(savedLogs);
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('assignments', JSON.stringify(assignments));
            localStorage.setItem('logs', JSON.stringify(logs));
        }
        
        // Save active tab to localStorage
        function saveActiveTab(tabName) {
            localStorage.setItem('activeTab', tabName);
        }
        
        // Load active tab from localStorage
        function loadActiveTab() {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && ['classrooms', 'create', 'assignments', 'analytics', 'profile'].includes(savedTab)) {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to saved tab and content
                document.querySelector(`[onclick="switchTab('${savedTab}')"]`).classList.add('active');
                document.getElementById(`${savedTab}-tab`).classList.add('active');
                
                // Load tab-specific data
                if (savedTab === 'classrooms') {
                    loadClassrooms();
                } else if (savedTab === 'assignments') {
                    loadAssignments();
                } else if (savedTab === 'analytics') {
                    loadAnalytics();
                } else if (savedTab === 'profile') {
                    loadTeacherProfile();
                }
            }
        }
        
        // Switch between tabs
        async function switchTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Save active tab
            localStorage.setItem('activeTab', tabName);
            
            // Load tab-specific content
            if (tabName === 'classrooms') {
                loadClassrooms();
            } else if (tabName === 'create') {
                // Form is already clean when switching to create tab
                // No need to reset as it's always fresh
            } else if (tabName === 'assignments') {
                loadAssignments();
            } else if (tabName === 'analytics') {
                await loadAnalytics();
            } else if (tabName === 'profile') {
                loadTeacherProfile();
            }
        }
        
        // Teacher profile functions
        async function loadTeacherProfile() {
            if (!currentTeacher) return;
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}`);
                const data = await response.json();
                const teacher = data.teacher;
                
                // Fill form fields
                document.getElementById('teacherName').value = teacher.name || '';
                document.getElementById('teacherEmail').value = teacher.email || '';
                document.getElementById('teacherSchool').value = teacher.school || '';
                document.getElementById('teacherTitle').value = teacher.title || '';
                document.getElementById('teacherBio').value = teacher.bio || '';
            } catch (error) {
                console.error('Error loading teacher profile:', error);
            }
        }
        
        async function updateTeacherProfile(event) {
            event.preventDefault();
            
            if (!currentTeacher) {
                showNotification('Error', 'Teacher not found', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        school: formData.get('school'),
                        title: formData.get('title'),
                        bio: formData.get('bio')
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Update current teacher data
                    currentTeacher = data.teacher;
                    localStorage.setItem('currentTeacher', JSON.stringify(currentTeacher));
                    
                    showNotification('Success', 'Profile updated successfully!', 'success');
                } else {
                    showNotification('Error', 'Error updating profile: ' + data.detail, 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error', 'Error updating profile', 'error');
            }
        }
        
        // Classroom management functions
        async function loadClassrooms() {
            if (!currentTeacher) {
                console.log('No current teacher found');
                return;
            }
            
            console.log('Loading classrooms for teacher:', currentTeacher.id);
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}/classrooms`);
                const data = await response.json();
                console.log('Classrooms response:', data);
                classrooms = data.classrooms || [];
                console.log('Classrooms loaded:', classrooms);
                displayClassrooms();
            } catch (error) {
                console.error('Error loading classrooms:', error);
                classrooms = [];
                displayClassrooms();
            }
        }
        
        async function loadClassroomSelect() {
            if (!currentTeacher) return;
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}/classrooms`);
                const data = await response.json();
                const classrooms = data.classrooms || [];
                
                const select = document.getElementById('assignmentClassroom');
                select.innerHTML = '<option value="">Select Classroom</option>' +
                    classrooms.map(classroom => 
                        `<option value="${classroom.id}">${classroom.name}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error loading classroom select:', error);
            }
        }
        
        function displayClassrooms() {
            const container = document.getElementById('classroomsGrid');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            const deleteBtn = document.getElementById('deleteSelectedClassroomsBtn');
            
            if (classrooms.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No classrooms yet</h3>
                        <p>Create your first classroom to get started</p>
                    </div>
                `;
                // Hide buttons when no classrooms
                toggleBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                return;
            }
            
            // Show buttons when classrooms exist
            toggleBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-block';
            toggleBtn.textContent = 'Select All';
            
            container.innerHTML = classrooms.map(classroom => {
                let levelInfo = '';
                if (classroom.spanish_level) {
                    levelInfo = classroom.spanish_level;
                    if (classroom.is_advanced) {
                        levelInfo += ' (Honors)';
                    }
                }
                
                return `
                    <div class="classroom-card">
                        <input type="checkbox" class="classroom-checkbox" value="${classroom.id}" onchange="updateClassroomsToggleBtn()">
                        <div class="classroom-header">
                            <div class="classroom-title">${classroom.name}</div>
                            <div class="classroom-meta">
                                <span class="join-code">ðŸ”‘ ${classroom.join_code}</span>
                                ${levelInfo ? `<span>ðŸ‡ªðŸ‡¸ ${levelInfo}</span>` : ''}
                            </div>
                        </div>
                        ${classroom.description ? `<div class="classroom-description">${classroom.description}</div>` : ''}
                        <div class="classroom-stats">
                            <div class="stat-item">
                                <div class="stat-number">${classroom.student_count || 0}</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${classroom.assignment_count || 0}</div>
                                <div class="stat-label">Assignments</div>
                            </div>
                        </div>
                        <div class="classroom-actions">
                            <button class="btn btn-primary btn-small" onclick="viewClassroom('${classroom.id}')">View Details</button>
                            <button class="btn btn-secondary btn-small" onclick="copyJoinCode('${classroom.join_code}')">Copy Code</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showCreateClassroomModal() {
            document.getElementById('createClassroomModal').classList.add('active');
        }
        
        function closeCreateClassroomModal() {
            document.getElementById('createClassroomModal').classList.remove('active');
            // Reset form
            document.querySelector('#createClassroomModal form').reset();
        }
        
        async function createClassroom(event) {
            event.preventDefault();
            
            if (!currentTeacher) {
                alert('Please set up teacher account first');
                return;
            }
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`/api/classrooms?teacher_id=${currentTeacher.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        description: formData.get('description'),
                        grade_level: '',
                        subject: formData.get('gradeLevel'),
                        spanish_level: formData.get('gradeLevel'),
                        is_advanced: formData.get('advanced') === 'on'
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showNotification('Success', 'Classroom created successfully!', 'success');
                    closeCreateClassroomModal();
                    loadClassrooms();
                    loadClassroomSelect();
                } else {
                    console.error('Server response:', data);
                    showNotification('Error', 'Error creating classroom: ' + (data.detail || data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error creating classroom:', error);
                showNotification('Error', 'Error creating classroom: ' + error.message, 'error');
            }
        }
        
        function copyJoinCode(joinCode) {
            navigator.clipboard.writeText(joinCode).then(() => {
                showNotification('Success', 'Join code copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Error', 'Failed to copy join code', 'error');
            });
        }
        
        async function viewClassroom(classroomId) {
            const classroom = classrooms.find(c => c.id === classroomId);
            if (!classroom) return;
            
            // Show modal
            document.getElementById('classroomDetailsModal').classList.add('active');
            
            // Update header info
            let levelInfo = '';
            if (classroom.spanish_level) {
                levelInfo = classroom.spanish_level;
                if (classroom.is_advanced) {
                    levelInfo += ' (Honors)';
                }
            }
            
            document.getElementById('classroomDetailsInfo').innerHTML = `
                <strong>${classroom.name}</strong> â€¢ ðŸ”‘ ${classroom.join_code}
                ${levelInfo ? ` â€¢ ðŸ‡ªðŸ‡¸ ${levelInfo}` : ''}
            `;
            
            try {
                const response = await fetch(`/api/classrooms/${classroomId}/students`);
                const data = await response.json();
                const students = data.students || [];
                
                // Load classroom details content
                const content = document.getElementById('classroomDetailsContent');
                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Classroom Information</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Join Code</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${classroom.join_code}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Total Students</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${students.length}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Assignments</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${classroom.assignment_count || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${classroom.description ? `
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Description</h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <p style="color: #4a5568; line-height: 1.6; margin: 0;">${classroom.description}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div>
                            <h3 style="color: #333; margin-bottom: 10px;">Enrolled Students (${students.length})</h3>
                            <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                                ${students.length === 0 ? 
                                    '<div style="padding: 20px; text-align: center; color: #64748b;">No students enrolled yet</div>' :
                                    students.map(student => `
                                        <div style="padding: 12px 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500; color: #2d3748;">${student.name}</div>
                                                ${student.email ? `<div style="font-size: 13px; color: #64748b;">${student.email}</div>` : ''}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                ${student.grade_level ? `<span style="background: #f8fafc; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #64748b;">${student.grade_level}</span>` : ''}
                                                <span style="background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Enrolled</span>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading classroom details:', error);
                document.getElementById('classroomDetailsContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>Error loading classroom details</p>
                    </div>
                `;
            }
        }
        
        function closeClassroomDetailsModal() {
            document.getElementById('classroomDetailsModal').classList.remove('active');
        }
        
        // Classroom selection functions
        function toggleClassroomsSelection() {
            const checkboxes = document.querySelectorAll('.classroom-checkbox');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            const selectAll = toggleBtn.textContent === 'Select All';
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            toggleBtn.textContent = selectAll ? 'Deselect All' : 'Select All';
        }
        
        function updateClassroomsToggleBtn() {
            const checkboxes = document.querySelectorAll('.classroom-checkbox');
            const checkedBoxes = document.querySelectorAll('.classroom-checkbox:checked');
            const toggleBtn = document.getElementById('classroomsToggleBtn');
            
            if (checkboxes.length === 0) return;
            
            if (checkedBoxes.length === 0) {
                toggleBtn.textContent = 'Select All';
            } else if (checkedBoxes.length === checkboxes.length) {
                toggleBtn.textContent = 'Deselect All';
            } else {
                toggleBtn.textContent = 'Select All';
            }
        }
        
        async function deleteSelectedClassrooms() {
            const checkedBoxes = document.querySelectorAll('.classroom-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                showNotification('Warning', 'Please select at least one classroom to delete', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} classroom(s)? This will also delete all assignments and student enrollments.`)) {
                return;
            }
            
            const classroomIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            try {
                const deletePromises = classroomIds.map(async (classroomId, index) => {
                    const response = await fetch(`/api/classrooms/${classroomId}`, { method: 'DELETE' });
                    return { classroomId, response, index };
                });
                
                const results = await Promise.all(deletePromises);
                
                const successful = results.filter(r => r.response.ok);
                const failed = results.filter(r => !r.response.ok);
                
                if (failed.length === 0) {
                    showNotification('Success', `${classroomIds.length} classroom(s) deleted successfully`, 'success');
                    loadClassrooms();
                    loadClassroomSelect();
                } else {
                    const failedDetails = failed.map(f => {
                        const statusText = f.response.status;
                        const errorText = f.response.status === 404 ? 'Classroom not found' : 'Server error';
                        return `Classroom ${classroomIds[f.index]}: ${statusText} - ${errorText}`;
                    }).join('\n');
                    
                    showNotification('Error', `Some classrooms could not be deleted:\n\n${failedDetails}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting classrooms:', error);
                showNotification('Error', 'Error deleting classrooms: ' + error.message, 'error');
            }
        }
        
        // Create assignment
        async function createAssignment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const vocabText = formData.get('vocab') || '';
            const vocabList = vocabText.split(',').map(v => v.trim()).filter(v => v.length > 0);
            
            try {
                const response = await fetch('/api/classroom-assignments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        classroom_id: formData.get('classroom_id'),
                        title: formData.get('title'),
                        description: formData.get('description'),
                        instructions: formData.get('instructions'),
                        level: formData.get('level'),
                        duration: parseInt(formData.get('duration')),
                        due_date: formData.get('due_date') || null,
                        prompt: formData.get('prompt'),
                        vocab: vocabList,
                        min_vocab_words: parseInt(formData.get('min_vocab_words')) || 0
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Reset form
                    event.target.reset();
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10001;
                        font-weight: 500;
                        font-size: 14px;
                    `;
                    successDiv.textContent = 'Assignment created successfully!';
                    document.body.appendChild(successDiv);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);
                    
                    // Reload assignments from database
                    await loadAssignments();
                    
                    // Switch to assignments tab
                    document.querySelector('[onclick="switchTab(\'assignments\')"]').click();
                } else {
                    alert('Error creating assignment: ' + data.detail);
                }
            } catch (error) {
                console.error('Error creating assignment:', error);
                alert('Error creating assignment');
            }
        }
        
        // Recalculate assignment statistics from logs
        function recalculateAssignmentStats() {
            assignments.forEach(assignment => {
                // Get all logs for this assignment
                const assignmentLogs = logs.filter(log => log.assignmentId === assignment.id);
                
                // Count unique students
                const uniqueStudents = new Set(assignmentLogs.map(log => log.studentName));
                assignment.studentCount = uniqueStudents.size;
                
                // Count completed sessions
                assignment.completionCount = assignmentLogs.filter(log => log.completed).length;
            });
            
            saveData();
        }
        
        // Load assignments
        async function loadAssignments() {
            if (!currentTeacher) {
                console.log('No current teacher found');
                return;
            }
            
            console.log('Loading assignments for teacher:', currentTeacher.id);
            
            try {
                const response = await fetch(`/api/teachers/${currentTeacher.id}/assignments`);
                const data = await response.json();
                console.log('Assignments response:', data);
                assignments = data.assignments || [];
                console.log('Assignments loaded:', assignments);
                displayAssignments();
            } catch (error) {
                console.error('Error loading assignments:', error);
                assignments = [];
                displayAssignments();
            }
        }
        
        function displayAssignments() {
            const container = document.getElementById('assignmentsList');
            
            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No assignments yet</h3>
                        <p>Create your first assignment to get started</p>
                    </div>
                `;
                // Reset toggle button
                const toggleBtn = document.getElementById('assignmentsToggleBtn');
                if (toggleBtn) toggleBtn.textContent = 'Select All';
                return;
            }
            
            container.innerHTML = assignments.map(assignment => {
                const studentText = assignment.completion_count === 1 ? 'student' : 'students';
                return `
                <div class="assignment-card">
                    <div class="assignment-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="assignment-checkbox" value="${assignment.id}" onchange="updateAssignmentsToggleBtn()">
                            <div>
                                <div class="assignment-title">${assignment.title}</div>
                                <div class="assignment-meta">
                                    <span class="level-badge level-${assignment.level}">${assignment.level}</span>
                                    <span>â±ï¸ ${assignment.duration} min</span>
                                    <span>ðŸ“š ${assignment.classroom_name}</span>
                                    <span>${assignment.completion_count} ${studentText} completed</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="assignment-description">${assignment.description}</div>
                    <div class="assignment-actions">
                        <button class="btn btn-primary btn-small" onclick="shareAssignment('${assignment.id}')">Share</button>
                        <button class="btn btn-secondary btn-small" onclick="viewAssignmentLogs('${assignment.id}')">View Logs</button>
                        <button class="btn btn-secondary btn-small" onclick="editAssignment('${assignment.id}')">Edit</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteAssignment('${assignment.id}')">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
            
            // Reset toggle button text
            const toggleBtn = document.getElementById('assignmentsToggleBtn');
            if (toggleBtn) toggleBtn.textContent = 'Select All';
        }
        
        // Update assignments toggle button text based on checkbox states
        function updateAssignmentsToggleBtn() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            if (allChecked && checkboxes.length > 0) {
                button.textContent = 'Deselect All';
            } else {
                button.textContent = 'Select All';
            }
        }
        
        // Share assignment
        function shareAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            const shareUrl = `${window.location.origin}/student?assignment=${assignmentId}`;
            document.getElementById('shareLink').textContent = shareUrl;
            document.getElementById('shareModal').classList.add('active');
        }
        
        // Copy share link
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(shareLink).then(() => {
                alert('Link copied to clipboard!');
            });
        }
        
        // Close share modal
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }
        
        // View assignment logs
        function viewAssignmentLogs(assignmentId) {
            // Switch to analytics tab
            document.querySelector('[onclick="switchTab(\'analytics\')"]').click();
            
            // Wait for tab to switch, then filter logs
            setTimeout(() => {
                filterLogsByAssignment(assignmentId);
            }, 100);
        }
        
        // Filter logs by specific assignment
        function filterLogsByAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            // Filter logs for this assignment only
            const assignmentLogs = logs.filter(log => log.assignmentId === assignmentId);
            
            // Update the logs table with filtered results
            const container = document.getElementById('logsContainer');
            if (assignmentLogs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No student submissions yet</h3>
                        <p>No students have completed this assignment yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">Student Submissions for: ${assignment.title}</h3>
                <div class="logs-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllLogsCheckbox" onchange="toggleLogsSelection()"></th>
                                <th>Student Name</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Messages</th>
                                <th>Voice Used</th>
                                <th>Vocabulary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignmentLogs.map(log => {
                                const startTime = new Date(log.startTime).toLocaleString();
                                const endTime = log.endTime ? new Date(log.endTime).toLocaleString() : 'In Progress';
                                const duration = log.endTime ? 
                                    Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) + ' min' : 
                                    'In Progress';
                                
                                const vocabDisplay = log.usedVocab && log.usedVocab.length > 0 ? 
                                    log.usedVocab.slice(0, 3).join(', ') + (log.usedVocab.length > 3 ? '...' : '') : 
                                    'None';
                                
                                return `
                                    <tr>
                                        <td><input type="checkbox" class="log-checkbox" value="${log.assignmentId}-${log.studentName}-${log.startTime}" style="width: 16px; height: 16px;" onchange="updateLogsToggleBtn()"></td>
                                        <td>${log.studentName}</td>
                                        <td>${startTime}</td>
                                        <td>${duration}</td>
                                        <td>${log.messageCount || 0}</td>
                                        <td>${log.voiceUsed ? 'Yes' : 'No'}</td>
                                        <td>${vocabDisplay}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="viewConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}')">
                                                View Conversation
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Reset toggle button
            const toggleBtn = document.getElementById('logsToggleBtn');
            if (toggleBtn) toggleBtn.textContent = 'Select All';
        }
        
        // Edit assignment
        function editAssignment(assignmentId) {
            console.log('editAssignment called with ID:', assignmentId);
            console.log('Available assignments:', assignments);
            
            const assignment = assignments.find(a => a.id === assignmentId);
            console.log('Found assignment:', assignment);
            
            if (!assignment) {
                console.error('Assignment not found with ID:', assignmentId);
                return;
            }
            
            console.log('Populating modal...');
            
            // Populate the edit modal with assignment data
            document.getElementById('editAssignmentId').value = assignment.id;
            document.getElementById('editAssignmentTitle').value = assignment.title;
            document.getElementById('editAssignmentLevel').value = assignment.level;
            document.getElementById('editAssignmentDuration').value = assignment.duration;
            document.getElementById('editAssignmentDueDate').value = assignment.due_date ? new Date(assignment.due_date).toISOString().slice(0, 16) : '';
            document.getElementById('editAssignmentPrompt').value = assignment.prompt;
            document.getElementById('editAssignmentDescription').value = assignment.description;
            document.getElementById('editAssignmentInstructions').value = assignment.instructions;
            document.getElementById('editAssignmentVocab').value = assignment.vocab ? assignment.vocab.join(', ') : '';
            document.getElementById('editMinVocabWords').value = assignment.min_vocab_words || 0;
            
            // Set classroom dropdown
            const classroomSelect = document.getElementById('editAssignmentClassroom');
            if (classroomSelect) {
                // Clear existing options
                classroomSelect.innerHTML = '<option value="">Select Classroom</option>';
                
                // Add classroom options
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id;
                    option.textContent = classroom.name;
                    classroomSelect.appendChild(option);
                });
                
                // Set the value to the assignment's classroom
                classroomSelect.value = assignment.classroom_id;
            }
            
            console.log('Showing modal...');
            
            // Show the modal
            const modal = document.getElementById('editAssignmentModal');
            console.log('Modal element:', modal);
            modal.classList.add('active');
            
            console.log('Modal should now be visible');
        }
        
        // Close edit assignment modal
        function closeEditAssignmentModal() {
            document.getElementById('editAssignmentModal').classList.remove('active');
        }
        
        // Update assignment (form submission for edit modal)
        async function updateAssignment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const assignmentId = formData.get('assignment_id');
            const vocabText = formData.get('vocab') || '';
            const vocabList = vocabText.split(',').map(v => v.trim()).filter(v => v.length > 0);
            
            try {
                const response = await fetch(`/api/assignments/${assignmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: formData.get('title'),
                        description: formData.get('description'),
                        instructions: formData.get('instructions'),
                        level: formData.get('level'),
                        duration: parseInt(formData.get('duration')),
                        due_date: formData.get('due_date') || null,
                        prompt: formData.get('prompt'),
                        vocab: vocabList,
                        min_vocab_words: parseInt(formData.get('min_vocab_words')) || 0
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Close modal
                    closeEditAssignmentModal();
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10001;
                        font-weight: 500;
                        font-size: 14px;
                    `;
                    successDiv.textContent = 'Assignment updated successfully!';
                    document.body.appendChild(successDiv);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);
                    
                    // Reload assignments from database
                    await loadAssignments();
                } else {
                    alert('Error updating assignment: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating assignment:', error);
                alert('Error updating assignment. Please try again.');
            }
        }
        
        // Delete assignment
        async function deleteAssignment(assignmentId) {
            if (confirm('Are you sure you want to delete this assignment?')) {
                try {
                    const response = await fetch(`/api/assignments/${assignmentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Reload assignments from database
                        await loadAssignments();
                    } else {
                        const data = await response.json();
                        alert('Error deleting assignment: ' + data.detail);
                    }
                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    alert('Error deleting assignment');
                }
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            console.log('Loading analytics...');
            
            // First load fresh data from server
            await loadData();
            
            console.log('Assignments:', assignments.length);
            console.log('Logs:', logs.length);
            
            // Debug: Show first few logs and assignments
            console.log('First 3 logs:', logs.slice(0, 3));
            console.log('First 3 assignments:', assignments.slice(0, 3));
            
            // Update stats
            const uniqueStudents = new Set(logs.map(log => log.studentName)).size;
            const completedAssignments = logs.filter(log => log.completed).length;
            const totalVocabUsed = logs.reduce((sum, log) => sum + (log.usedVocabCount || 0), 0);
            const voiceUsageCount = logs.filter(log => log.voiceUsed).length;
            const avgCompletionRate = logs.length > 0 ? Math.round((completedAssignments / logs.length) * 100) : 0;
            const voiceUsageRate = logs.length > 0 ? Math.round((voiceUsageCount / logs.length) * 100) : 0;
            
            // Calculate vocabulary performance metrics
            const vocabRequirementsMet = logs.filter(log => {
                const minVocab = log.minVocabWords || 0;
                const usedVocab = log.usedVocabCount || 0;
                return minVocab > 0 && usedVocab >= minVocab;
            }).length;
            
            const totalVocabRequirements = logs.filter(log => (log.minVocabWords || 0) > 0).length;
            const vocabRequirementRate = totalVocabRequirements > 0 ? Math.round((vocabRequirementsMet / totalVocabRequirements) * 100) : 0;
            
            console.log('Calculated stats:', {
                uniqueStudents,
                completedAssignments,
                totalVocabUsed,
                voiceUsageCount,
                avgCompletionRate,
                voiceUsageRate
            });
            
            document.getElementById('totalAssignments').textContent = assignments.length;
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('avgCompletion').textContent = avgCompletionRate + '%';
            document.getElementById('voiceUsage').textContent = voiceUsageRate + '%';
            
            // Load logs table
            const tableBody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">No student activity logs found. Students need to complete assignments for data to appear here.</td></tr>';
                return;
            }
            
            console.log('Building logs table...');
            
            // Debug: Check if submitted_for_grading field exists
            console.log('Sample log with submitted field:', logs[0]);
            console.log('Logs with submitted_for_grading:', logs.filter(l => l.submitted_for_grading).length);
            
            // Filter logs to show only submitted attempt (or most recent if none submitted) per student per assignment
            const filteredLogs = {};
            logs.forEach(log => {
                const key = `${log.studentId}-${log.assignmentId}`;
                console.log(`Processing log for ${log.studentName} - ${log.assignmentId}: submitted=${log.submitted_for_grading}, attempt=${log.attemptNumber}`);
                
                if (!filteredLogs[key]) {
                    filteredLogs[key] = log;
                } else {
                    const current = filteredLogs[key];
                    // Prefer submitted attempt
                    if (log.submitted_for_grading && !current.submitted_for_grading) {
                        console.log(`  Replacing with submitted attempt #${log.attemptNumber}`);
                        filteredLogs[key] = log;
                    }
                    // If both submitted or neither submitted, prefer newer
                    else if (log.submitted_for_grading === current.submitted_for_grading && 
                             new Date(log.createdAt) > new Date(current.createdAt)) {
                        console.log(`  Replacing with newer attempt #${log.attemptNumber}`);
                        filteredLogs[key] = log;
                    }
                }
            });
            
            console.log('Filtered logs count:', Object.keys(filteredLogs).length);
            
            // Store all logs for previous attempts feature
            window.allLogs = logs;
            
            // Use filtered logs for main table
            const displayLogs = Object.values(filteredLogs);
            
            // Store displayLogs globally for viewConversation function
            window.displayLogs = displayLogs;
            
            console.log('Display logs stored globally:', window.displayLogs.length);
            
            tableBody.innerHTML = displayLogs.map(log => {
                const assignment = assignments.find(a => a.id === log.assignmentId);
                const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
                const assignmentVocab = assignment ? assignment.vocab || [] : [];
                
                // Check if there are multiple attempts for this student/assignment
                const studentAttempts = window.allLogs.filter(l => 
                    l.assignmentId === log.assignmentId && 
                    l.studentName === log.studentName
                );
                const hasMultipleAttempts = studentAttempts.length > 1;
                
                // Debug: Log assignment matching
                if (!assignment) {
                    console.log('No assignment found for log:', log);
                }
                
                // Check vocabulary usage count and minimum requirement
                const vocabCount = log.usedVocabCount || 0;
                const minVocabWords = log.minVocabWords || 0;
                
                // Create vocabulary display with fraction and color coding
                let vocabDisplay;
                let vocabColor;
                
                if (minVocabWords > 0) {
                    // Show as fraction when there's a minimum requirement
                    vocabDisplay = `${vocabCount}/${minVocabWords}`;
                    // Color coding: red for below minimum, green for meeting or exceeding
                    vocabColor = vocabCount >= minVocabWords ? '#10b981' : '#ef4444';
                } else {
                    // Show just the count when no minimum requirement
                    vocabDisplay = vocabCount.toString();
                    vocabColor = '#666'; // Neutral gray color
                }
                
                // Get due date and check if submitted on time
                const dueDate = assignment ? assignment.due_date : null;
                const dueDateDisplay = dueDate ? new Date(dueDate).toLocaleDateString() : 'No due date';
                
                let onTimeDisplay = 'N/A';
                if (dueDate && log.completed && log.endTime) {
                    const submittedTime = new Date(log.endTime);
                    const dueTime = new Date(dueDate);
                    const isOnTime = submittedTime <= dueTime;
                    
                    if (isOnTime) {
                        onTimeDisplay = '<span style="color: #10b981; font-weight: 600;">âœ… Yes</span>';
                    } else {
                        const daysLate = Math.ceil((submittedTime - dueTime) / (1000 * 60 * 60 * 24));
                        onTimeDisplay = `<span style="color: #ef4444; font-weight: 600;">âŒ ${daysLate} day${daysLate !== 1 ? 's' : ''} late</span>`;
                    }
                } else if (dueDate && !log.completed) {
                    onTimeDisplay = '<span style="color: #f59e0b;">â±ï¸ Pending</span>';
                }
                
                return `
                    <tr>
                        <td><input type="checkbox" class="log-checkbox" value="${log.assignmentId}-${log.studentName}-${log.startTime}" style="width: 16px; height: 16px;" onchange="updateLogsToggleBtn()"></td>
                        <td>
                            <div>${log.studentName || 'Anonymous'}</div>
                            ${hasMultipleAttempts ? `<button class="btn btn-info btn-xs" onclick="viewStudentHistory('${log.assignmentId}', '${log.studentName}', '${log.studentId}')" style="font-size: 10px; padding: 2px 6px; margin-top: 4px; white-space: nowrap;">Previous Attempts</button>` : ''}
                        </td>
                        <td>${assignmentTitle}</td>
                        <td><span class="level-badge level-${log.level}">${log.level}</span></td>
                        <td>${assignment ? new Date(assignment.created_at).toLocaleDateString() : 'Unknown'}</td>
                        <td>${dueDateDisplay}</td>
                        <td>${onTimeDisplay}</td>
                        <td>${log.messageCount || 0}</td>
                        <td style="color: ${vocabColor}; font-weight: 500;">${vocabDisplay}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">Attempt #${log.attemptNumber || 1}</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="viewConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}')">
                                View Conversation
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('Analytics loading complete');
        }
        
        // View student history for all attempts
        async function viewStudentHistory(assignmentId, studentName, studentId) {
            try {
                // Use the stored all logs instead of fetching again
                const allLogs = window.allLogs || [];
                
                // Filter for this specific student and assignment
                const studentLogs = allLogs.filter(log => 
                    log.assignmentId === assignmentId && 
                    log.studentName === studentName
                ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Most recent first
                
                console.log('All logs for this student/assignment:', studentLogs.length);
                
                if (studentLogs.length <= 1) {
                    alert('No previous attempts found for this student and assignment.');
                    return;
                }
                
                // Find which attempt is displayed in main table (submitted or most recent)
                const displayedLog = window.displayLogs?.find(log => 
                    log.assignmentId === assignmentId && 
                    log.studentName === studentName
                );
                
                console.log('Displayed log:', displayedLog);
                
                // Remove the displayed attempt from previous attempts
                const previousAttempts = studentLogs.filter(log => log.id !== displayedLog?.id);
                
                console.log('Previous attempts (excluding displayed):', previousAttempts.length);
                
                if (previousAttempts.length === 0) {
                    alert('No previous attempts found for this student and assignment.');
                    return;
                }
                
                previousAttempts.forEach((log, index) => {
                    console.log(`History modal - Log ${index}:`, {
                        attemptNumber: log.attemptNumber,
                        startTime: log.startTime,
                        createdAt: log.createdAt
                    });
                });
                
                // Create history modal
                const modalHtml = `
                    <div id="historyModal" class="modal active">
                        <div class="modal-content" style="width: 800px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3>${studentName} - Previous Attempts (${previousAttempts.length})</h3>
                                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                ${previousAttempts.map((log, index) => {
                                    // Prepare date string outside template literal
                                    let dateString = 'Date not available';
                                    try {
                                        if (log.startTime) {
                                            const date = new Date(log.startTime);
                                            if (!isNaN(date.getTime())) {
                                                dateString = date.toLocaleString();
                                            }
                                        }
                                        if (dateString === 'Date not available' && log.endTime) {
                                            const endDate = new Date(log.endTime);
                                            if (!isNaN(endDate.getTime())) {
                                                dateString = endDate.toLocaleString();
                                            }
                                        }
                                        if (dateString === 'Date not available' && log.createdAt) {
                                            const createdDate = new Date(log.createdAt);
                                            if (!isNaN(createdDate.getTime())) {
                                                dateString = createdDate.toLocaleString();
                                            }
                                        }
                                    } catch (e) {
                                        dateString = 'Date error';
                                    }
                                    return `
                                    <div style="margin-bottom: 20px; padding: 24px; border: 1px solid #e2e8f0; border-radius: 12px; background: ${index === 0 ? 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)' : '#ffffff'}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.2s ease;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">
                                                    #${log.attemptNumber || 1}
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0; color: #1e40af; font-size: 18px; font-weight: 600;">
                                                        Attempt ${log.attemptNumber || 1}
                                                    </h4>
                                                    <span style="color: #64748b; font-size: 13px; font-weight: 500;">
                                                        ${log.completed ? 'âœ“ Completed' : 'â—‹ Incomplete'} â€¢ ${dateString}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border-left: 3px solid #6366f1;">
                                                <span style="font-size: 11px; color: #6366f1; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Messages</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.messageCount || 0}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border-left: 3px solid ${log.usedVocabCount >= (log.minVocabWords || 0) ? '#10b981' : '#ef4444'};">
                                                <span style="font-size: 11px; color: ${log.usedVocabCount >= (log.minVocabWords || 0) ? '#10b981' : '#ef4444'}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Vocabulary</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.usedVocabCount || 0}/${log.minVocabWords || 0}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                                <span style="font-size: 11px; color: #f59e0b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Duration</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.startTime && log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) + ' min' : 'N/A'}</span>
                                            </div>
                                            <div style="display: flex; flex-direction: column; padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                                                <span style="font-size: 11px; color: #8b5cf6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Voice</span>
                                                <span style="font-size: 16px; font-weight: 600; color: #1e293b;">${log.voiceUsed ? 'Yes' : 'No'}</span>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" onclick="viewHistoryConversation('${log.assignmentId}', '${log.studentName}', '${log.startTime}', '${log.attemptNumber || 1}')">
                                            View Conversation
                                        </button>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading student history:', error);
                alert('Error loading student history. Please try again.');
            }
        }
        
        // Close history modal
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // View conversation from history modal (closes history modal first)
        async function viewHistoryConversation(assignmentId, studentName, startTime, attemptNumber) {
            console.log('Viewing history conversation:', { assignmentId, studentName, startTime, attemptNumber });
            
            // Close history modal first
            closeHistoryModal();
            
            // Wait a moment for modal to close, then open conversation
            setTimeout(async () => {
                // First find the session ID, then get conversation directly
                try {
                    console.log('Fetching ALL logs to find session ID...');
                    const logsResponse = await fetch('/api/logs/all');
                    const logsData = await logsResponse.json();
                    const allLogs = logsData.logs || [];
                    
                    const log = allLogs.find(l => 
                        l.assignmentId === assignmentId && 
                        l.studentName === studentName && 
                        l.startTime === startTime
                    );
                    
                    console.log('Found log:', log);
                    
                    if (!log) {
                        console.error('Log not found. Available logs:', allLogs.slice(0, 3).map(l => ({ 
                        assignmentId: l.assignmentId, 
                        studentName: l.studentName, 
                        startTime: l.startTime 
                    })));
                        alert('Student log not found');
                        return;
                    }
                    
                    // Get session ID from the log
                    const sessionId = log.id;
                    console.log('Session ID:', sessionId);
                    
                    // Fetch conversation directly for this session
                    console.log('Fetching conversation for session:', sessionId);
                    const conversationResponse = await fetch(`/api/sessions/${sessionId}/conversation`);
                    console.log('Conversation response status:', conversationResponse.status);
                    
                    const conversationData = await conversationResponse.json();
                    console.log('Conversation data received:', conversationData);
                    
                    if (conversationData.error) {
                        console.error('Conversation error:', conversationData.error);
                        alert('Error loading conversation: ' + conversationData.error);
                        return;
                    }
                    
                    const conversation = conversationData.conversation || [];
                    console.log('Conversation loaded:', conversation.length, 'messages');
                    
                    if (conversation.length === 0) {
                        console.log('No conversation messages found');
                        alert('Conversation transcript not available - no conversation data was recorded');
                        return;
                    }
                    
                    console.log('First message:', conversation[0]);
                    console.log('Last message:', conversation[conversation.length - 1]);
                    
                    console.log('Loading conversation modal...');
                    
                    const assignment = assignments.find(a => a.id === assignmentId);
                    const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
                    const assignmentVocab = assignment ? assignment.vocab || [] : [];
                    
                    // Update modal header with session info including attempt number
                    document.getElementById('conversationTitle').textContent = `${studentName} - ${assignmentTitle} (Attempt #${attemptNumber})`;
                    
                    // Update session stats
                    const sessionDuration = log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) : 0;
                    document.getElementById('conversationStats').innerHTML = `
                        <span>${log.messageCount} messages</span>
                        <span>${log.voiceUsed ? 'Voice used' : 'Text only'}</span>
                        <span>${sessionDuration} minutes</span>
                        <span class="level-badge level-${log.level}">${log.level}</span>
                    `;
                    
                    // Update conversation meta (session info like main modal)
                    const sessionDate = log.start_time || log.startTime || log.endTime || log.createdAt;
                    document.getElementById('conversationMeta').innerHTML = `
                        Session: ${sessionDate ? new Date(sessionDate).toLocaleString() : 'Date not available'} ${log.completed ? '- Completed' : '- In Progress'}
                    `;
                    
                    // Hide vocabulary section completely
                    document.getElementById('conversationVocab').innerHTML = '';
                    
                    // Function to highlight vocabulary words in text
                    function highlightVocabulary(text, vocabList) {
                        let highlightedText = text;
                        vocabList.forEach(word => {
                            const regex = new RegExp(`\\b${word}\\b`, 'gi');
                            highlightedText = highlightedText.replace(regex, `<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px; font-weight: 600;">${word}</mark>`);
                        });
                        return highlightedText;
                    }
                    
                    // Display conversation with highlighted vocabulary
                    const conversationContainer = document.getElementById('conversationContent');
                    conversationContainer.innerHTML = `
                        <h5 style="margin: 20px 0 15px 0; color: #333;">Conversation Transcript</h5>
                        ${conversation.map(msg => {
                            const senderClass = msg.message_type === 'user' ? 'user-message' : 'bot-message';
                            const senderLabel = msg.message_type === 'user' ? studentName : 'AI Tutor';
                            const timestamp = new Date(msg.timestamp || msg.created_at).toLocaleTimeString();
                            
                            // Only highlight vocabulary in student messages
                            const highlightedContent = msg.message_type === 'user' ? 
                                highlightVocabulary(msg.content, assignmentVocab) : 
                                msg.content;
                            
                            return `
                                <div class="message ${senderClass}" style="margin-bottom: 15px; padding: 12px; border-radius: 8px; background: ${msg.message_type === 'user' ? '#e3f2fd' : '#f3e5f5'};">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">${senderLabel} - ${timestamp}</div>
                                    <div style="line-height: 1.5;">${highlightedContent}</div>
                                </div>
                            `;
                        }).join('')}
                    `;
                    
                    // Show modal with same dimensions as main conversation
                    const conversationModal = document.getElementById('conversationModal');
                    console.log('Conversation modal element found:', conversationModal);
                    
                    const modalContent = conversationModal.querySelector('.modal-content');
                    console.log('Modal content element found:', modalContent);
                    
                    if (modalContent) {
                        // Debug: Log current styles
                        console.log('Current modal content styles:', {
                            width: modalContent.style.width,
                            maxWidth: modalContent.style.maxWidth,
                            computedWidth: window.getComputedStyle(modalContent).width,
                            computedMaxWidth: window.getComputedStyle(modalContent).maxWidth
                        });
                        
                        // Force exact same styling as main modal uses
                        modalContent.style.width = '800px';
                        modalContent.style.maxWidth = '90%';
                        modalContent.style.maxHeight = '90vh';
                        modalContent.style.overflowY = 'auto';
                    } else {
                        console.error('Modal content not found!');
                    }
                    
                    conversationModal.classList.add('active');
                    console.log('Conversation modal should now be visible with forced dimensions');
                    
                } catch (error) {
                    console.error('Error loading conversation:', error);
                    alert('Error loading conversation. Please try again. Error: ' + error.message);
                }
            }, 300);
        }
        
        // Update logs toggle button text based on checkbox states
        function updateLogsToggleBtn() {
            const button = document.getElementById('logsToggleBtn');
            const checkboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            if (allChecked && checkboxes.length > 0) {
                button.textContent = 'Deselect All';
                selectAllCheckbox.checked = true;
            } else {
                button.textContent = 'Select All';
                selectAllCheckbox.checked = false;
            }
        }
        
        // Initialize
        loadData();
        loadActiveTab(); // Load saved tab state
        
        // View conversation function
        async function viewConversation(assignmentId, studentName, startTime) {
            console.log('Viewing conversation:', { assignmentId, studentName, startTime });
            
            // First try to find in the filtered display logs (submitted attempts)
            let log = window.displayLogs?.find(l => 
                l.assignmentId === assignmentId && 
                l.studentName === studentName && 
                l.startTime === startTime
            );
            
            // If not found in display logs, try the original logs array
            if (!log) {
                log = logs.find(l => 
                    l.assignmentId === assignmentId && 
                    l.studentName === studentName && 
                    l.startTime === startTime
                );
            }
            
            // If still not found, fetch all logs to find the specific session
            if (!log) {
                try {
                    const response = await fetch('/api/logs');
                    const data = await response.json();
                    const allLogs = data.logs || [];
                    log = allLogs.find(l => 
                        l.assignmentId === assignmentId && 
                        l.studentName === studentName && 
                        l.startTime === startTime
                    );
                } catch (error) {
                    console.error('Error fetching all logs:', error);
                }
            }
            
            console.log('Found log:', log);
            
            if (!log) {
                alert('Student log not found');
                return;
            }
            
            if (!log.conversation || log.conversation.length === 0) {
                alert('Conversation transcript not available - no conversation data was recorded');
                return;
            }
            
            const assignment = assignments.find(a => a.id === assignmentId);
            const assignmentTitle = assignment ? assignment.title : 'Unknown Assignment';
            const assignmentVocab = assignment ? assignment.vocab || [] : [];
            const usedVocab = log.usedVocab || [];
            
            // Update modal header with session info including attempt number
            document.getElementById('conversationTitle').textContent = `${studentName} - ${assignmentTitle} (Attempt #${log.attemptNumber || 1})`;
            
            // Update session stats
            const sessionDuration = log.endTime ? Math.round((new Date(log.endTime) - new Date(log.startTime)) / 60000) : 0;
            document.getElementById('conversationStats').innerHTML = `
                <span>${log.messageCount} messages</span>
                <span>${log.voiceUsed ? 'Voice used' : 'Text only'}</span>
                <span>${sessionDuration} minutes</span>
                <span class="level-badge level-${log.level}">${log.level}</span>
            `;
            
            // Update meta info
            const sessionDate = log.startTime || log.start_time || log.endTime || log.createdAt;
            document.getElementById('conversationMeta').innerHTML = `
                Session: ${sessionDate ? new Date(sessionDate).toLocaleString() : 'Date not available'} ${log.completed ? '- Completed' : '- In Progress'}
            `;
            
            // Hide vocabulary section completely
            document.getElementById('conversationVocab').innerHTML = '';
            
            // Function to highlight vocabulary words in text
            function highlightVocabulary(text, vocabList) {
                let highlightedText = text;
                vocabList.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    highlightedText = highlightedText.replace(regex, `<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px; font-weight: 600;">${word}</mark>`);
                });
                return highlightedText;
            }
            
            // Display conversation with highlighted vocabulary (but no vocabulary section)
            const conversationContent = document.getElementById('conversationContent');
            conversationContent.innerHTML = `
                <h5 style="margin: 20px 0 15px 0; color: #333;">Conversation Transcript</h5>
                ${log.conversation.map(msg => {
                    const senderClass = msg.message_type === 'user' ? 'user-message' : 'bot-message';
                    const senderLabel = msg.message_type === 'user' ? studentName : 'AI Tutor';
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString();
                    
                    // Only highlight vocabulary in student messages
                    const highlightedContent = msg.message_type === 'user' ? 
                        highlightVocabulary(msg.content, assignmentVocab) : 
                        msg.content;
                    
                    return `
                        <div class="message ${senderClass}" style="margin-bottom: 15px; padding: 12px; border-radius: 8px; background: ${msg.message_type === 'user' ? '#e3f2fd' : '#f3e5f5'};">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">${senderLabel} - ${timestamp}</div>
                            <div style="line-height: 1.5;">${highlightedContent}</div>
                        </div>
                    `;
                }).join('')}
            `;
            
            // Show modal
            document.getElementById('conversationModal').classList.add('active');
        }
        
        function closeConversationModal() {
            document.getElementById('conversationModal').classList.remove('active');
        }
        
        // Bulk selection functions
        function toggleAssignmentsSelection() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            if (allChecked) {
                // Deselect all
                checkboxes.forEach(checkbox => checkbox.checked = false);
                button.textContent = 'Select All';
            } else {
                // Select all
                checkboxes.forEach(checkbox => checkbox.checked = true);
                button.textContent = 'Deselect All';
            }
        }
        
        function selectAllAssignments() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            button.textContent = 'Deselect All';
        }
        
        function deselectAllAssignments() {
            const button = document.getElementById('assignmentsToggleBtn');
            const checkboxes = document.querySelectorAll('.assignment-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            button.textContent = 'Select All';
        }
        
        function getSelectedAssignments() {
            const checkboxes = document.querySelectorAll('.assignment-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function deleteSelectedAssignments() {
            const selectedIds = getSelectedAssignments();
            
            if (selectedIds.length === 0) {
                alert('Please select at least one assignment to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} assignment(s)? This action cannot be undone.`)) {
                // Remove assignments from array
                assignments = assignments.filter(a => !selectedIds.includes(a.id));
                
                // Also remove associated logs
                logs = logs.filter(log => !selectedIds.includes(log.assignmentId));
                
                // Save data
                saveData();
                
                // Refresh the assignments list
                loadAssignments();
                
                // Update analytics if on that tab
                if (document.querySelector('.nav-tab.active').textContent.includes('Analytics')) {
                    loadAnalytics();
                }
                
                alert(`Successfully deleted ${selectedIds.length} assignment(s).`);
            }
        }
        
        // Log management functions
        function toggleLogsSelection() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const allChecked = Array.from(logCheckboxes).every(cb => cb.checked);
            
            if (allChecked) {
                // Deselect all
                logCheckboxes.forEach(checkbox => checkbox.checked = false);
                selectAllCheckbox.checked = false;
                button.textContent = 'Select All';
            } else {
                // Select all
                logCheckboxes.forEach(checkbox => checkbox.checked = true);
                selectAllCheckbox.checked = true;
                button.textContent = 'Deselect All';
            }
        }
        
        function toggleAllLogs() {
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
            
            // Update button text
            if (selectAllCheckbox.checked) {
                button.textContent = 'Deselect All';
            } else {
                button.textContent = 'Select All';
            }
        }
        
        function selectAllLogs() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = true);
            selectAllCheckbox.checked = true;
            button.textContent = 'Deselect All';
        }
        
        function deselectAllLogs() {
            const button = document.getElementById('logsToggleBtn');
            const logCheckboxes = document.querySelectorAll('.log-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllLogsCheckbox');
            logCheckboxes.forEach(checkbox => checkbox.checked = false);
            selectAllCheckbox.checked = false;
            button.textContent = 'Select All';
        }
        
        function getSelectedLogs() {
            const checkboxes = document.querySelectorAll('.log-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function deleteSelectedLogs() {
            const selectedLogs = getSelectedLogs();
            
            if (selectedLogs.length === 0) {
                alert('Please select at least one log to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedLogs.length} student log(s)? This action cannot be undone.`)) {
                // Get the logs that will be deleted to update assignment stats
                const logsToDelete = logs.filter(log => {
                    const logKey = `${log.assignmentId}-${log.studentName}-${log.startTime}`;
                    return selectedLogs.includes(logKey);
                });
                
                // Remove logs from array
                logs = logs.filter(log => {
                    const logKey = `${log.assignmentId}-${log.studentName}-${log.startTime}`;
                    return !selectedLogs.includes(logKey);
                });
                
                // Update assignment statistics for each deleted log
                logsToDelete.forEach(deletedLog => {
                    const assignment = assignments.find(a => a.id === deletedLog.assignmentId);
                    if (assignment) {
                        // Decrement completion count if the log was completed
                        if (deletedLog.completed) {
                            assignment.completionCount = Math.max(0, (assignment.completionCount || 0) - 1);
                        }
                        
                        // Check if this was the only log for this student
                        const remainingLogsForStudent = logs.filter(log => 
                            log.assignmentId === deletedLog.assignmentId && 
                            log.studentName === deletedLog.studentName
                        );
                        
                        // If no more logs for this student, decrement student count
                        if (remainingLogsForStudent.length === 0) {
                            assignment.studentCount = Math.max(0, (assignment.studentCount || 0) - 1);
                        }
                    }
                });
                
                // Save data
                saveData();
                
                // Refresh the analytics display
                loadAnalytics();
                
                alert(`Successfully deleted ${selectedLogs.length} student log(s).`);
            }
        }
    </script>
    
    <!-- Edit Assignment Modal -->
    <div id="editAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Assignment</h2>
                <span class="modal-close" onclick="closeEditAssignmentModal()">&times;</span>
            </div>
            <form class="assignment-form" onsubmit="updateAssignment(event)">
                <input type="hidden" id="editAssignmentId" name="assignment_id">
                
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div class="form-group">
                        <label for="editAssignmentTitle">Assignment Title</label>
                        <input type="text" id="editAssignmentTitle" name="title" required placeholder="e.g., Ordering Food at a Restaurant">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAssignmentClassroom">Classroom</label>
                            <select id="editAssignmentClassroom" name="classroom_id" disabled>
                                <option value="">Select Classroom</option>
                            </select>
                            <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Classroom cannot be changed when editing</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editAssignmentLevel">Difficulty Level</label>
                            <select id="editAssignmentLevel" name="level" required>
                                <option value="">Select Level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAssignmentDuration">Duration (minutes)</label>
                            <input type="number" id="editAssignmentDuration" name="duration" min="1" max="60" step="1" value="5" required>
                        </div>
                        <div class="form-group">
                            <label for="editAssignmentDueDate">Due Date (Optional)</label>
                            <input type="datetime-local" id="editAssignmentDueDate" name="due_date">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Content Details</div>
                    <div class="form-group">
                        <label for="editAssignmentDescription">Assignment Description</label>
                        <textarea id="editAssignmentDescription" name="description" required placeholder="Describe what students should practice and accomplish in this assignment..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAssignmentInstructions">Student Instructions</label>
                        <textarea id="editAssignmentInstructions" name="instructions" required placeholder="Clear instructions for students on how to complete this assignment..."></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">Advanced Options</div>
                    <div class="form-group">
                        <label for="editAssignmentPrompt">Custom Prompt (Optional)</label>
                        <textarea id="editAssignmentPrompt" name="prompt" placeholder="Override the default system prompt with custom instructions for the AI..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAssignmentVocab">Key Vocabulary (Optional)</label>
                        <textarea id="editAssignmentVocab" name="vocab" placeholder="Enter important vocabulary words or phrases (comma-separated). These will be tracked in student logs..."></textarea>
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Example: zapatos, talla, color, precio, comprar, tienda</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="editMinVocabWords">Minimum Vocabulary Words Required</label>
                        <input type="number" id="editMinVocabWords" name="min_vocab_words" min="0" max="20" step="1" value="0" placeholder="Number of vocabulary words students must use">
                        <small style="color: #718096; font-size: 13px; margin-top: 6px; display: block;">Set to 0 for no minimum requirement. Students will be tracked on how many unique vocabulary words they use.</small>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-self: center;">Save Assignment</button>
            </form>
        </div>
    </div>
</body>
</html>
